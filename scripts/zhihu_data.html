<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>çŸ¥ä¹èˆ†æƒ…åˆ†æ - ç¤¾ä¼šé›·è¾¾</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="../CSS/data.css">
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>

<div id="loading">æ­£åœ¨è·å–æ•°æ®...</div>

<header>
  <div class="container nav">
    <div class="brand">ç¤¾ä¼šé›·è¾¾ Â· Social Radar</div>
    <div class="menu">
      <a href="../index.html">é¦–é¡µ</a>
      <div class="dropdown">
        <a href="javascript:void(0)" class="dropbtn active">æ•°æ®åˆ†æ</a>
        <div class="dropdown-content">
          <a href="zhihu_data.html" class="active">çŸ¥ä¹</a>
          <a href="weibo_data.html">å¾®ä¿¡å…¬ä¼—å·</a>
          <a href="xiaohongshu.html">å°çº¢ä¹¦</a>
        </div>
      </div>
      <a href="analysis.html">CSVåˆ†æ</a>
      <a href="work.html">æˆ‘ä»¬çš„å·¥ä½œ</a>
    </div>
  </div>
</header>

<div class="container">

  <div class="card">
    <h2>çŸ¥ä¹å…¨é‡æ•°æ®æ¦‚è§ˆ</h2>
    
    <div class="summary-bar">
        <div class="stat-box">
            <span class="stat-num" id="total-posts">0</span>
            <span class="stat-label">ç›‘æ§å†…å®¹æ€»é‡</span>
        </div>
        <div class="stat-box">
            <span class="stat-num" id="total-people">0</span>
            <span class="stat-label">è¦†ç›–è¯é¢˜/äººç‰©</span>
        </div>
    </div>

    <div class="charts-wrapper">
      <div>
        <h3>æ€»çƒ­åº¦è¶‹åŠ¿ï¼ˆæŒ‰æœˆï¼‰</h3>
        <div id="global-month" class="chart-container"></div>
      </div>
      <div>
        <h3>æœ€è¿‘ä¸€å‘¨çƒ­åº¦ï¼ˆæŒ‰æ—¥ï¼‰</h3>
        <div id="global-week" class="chart-container"></div>
      </div>
    </div>
  </div>

  <div class="card" style="margin: 20px 0; padding: 15px; display: flex; align-items: center; gap: 15px; background: #f9f9f9; border: 1px solid #eee;">
      <h3 style="margin: 0; font-size: 16px;">ğŸ” æ•°æ®ç­›é€‰ï¼š</h3>
      <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
          <input type="checkbox" id="negative-filter" onchange="toggleFilter()">
          <span style="color: #d32f2f; font-weight: bold;">åªçœ‹â€œè´Ÿé¢/äº‰è®®â€å†…å®¹</span>
      </label>
      <span style="color: #999; font-size: 12px;">(å…³é”®è¯ï¼šé¿é›·, è¸©å‘, ç”šè‡³, å¤±æœ›, å·®è¯„, åæ§½, è´¨ç–‘, éª—å­...)</span>
  </div>

  <div id="content-area"></div>

</div>

<script>
// å¯¼èˆªæ é«˜äº®é€»è¾‘
document.addEventListener('DOMContentLoaded', function() {
    var currentUrl = window.location.pathname;
    var menuLinks = document.querySelectorAll('.menu a');
    menuLinks.forEach(function(link) {
        if (link.getAttribute('href') && currentUrl.includes(link.getAttribute('href'))) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });
});

const CURRENT_DATE = new Date('2026-01-02');
// å®šä¹‰è´Ÿé¢å…³é”®è¯
const NEGATIVE_KEYWORDS = ["é¿é›·", "è¸©å‘", "ç”šè‡³", "å¤±æœ›", "å·®è¯„", "åæ§½", "é»‘æ¦œ", "åƒåœ¾", "æ— è¯­", "åˆ«å»", "åˆ«ä¹°", "åæ‚”", "ä¸Šå½“", "è´¨ç–‘", "éª—å­", "æ¶å¿ƒ", "ä¸è¡Œ", "çƒ‚"];

// å…¨å±€æ•°æ®
let GLOBAL_ALL_DATA = [];

/* ================= ç­›é€‰é€»è¾‘ ================= */
function toggleFilter() {
    const isFilterOn = document.getElementById('negative-filter').checked;
    const area = document.getElementById('content-area');
    
    // é‡æ–°åˆ†ç»„
    const grouped = {};
    let filteredCount = 0;

    GLOBAL_ALL_DATA.forEach(d => {
        // ç­›é€‰é€»è¾‘
        if (isFilterOn) {
            // æ£€æŸ¥æ ‡é¢˜æˆ–æ‘˜è¦ä¸­æ˜¯å¦åŒ…å«è´Ÿé¢è¯
            const textToCheck = (d.title + d.excerpt).toLowerCase();
            const hasNegativeWord = NEGATIVE_KEYWORDS.some(kw => textToCheck.includes(kw));
            if (!hasNegativeWord) return;
        }

        grouped[d.keyword] = grouped[d.keyword] || [];
        grouped[d.keyword].push(d);
        filteredCount++;
    });

    // å¦‚æœç­›é€‰åæ²¡æ•°æ®
    if (Object.keys(grouped).length === 0) {
        area.innerHTML = '<div style="text-align:center; padding:50px; color:#999;">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è´Ÿé¢å†…å®¹</div>';
        document.getElementById('total-posts').innerText = filteredCount + (isFilterOn ? " (ç­›é€‰å)" : "");
        document.getElementById('total-people').innerText = 0;
        return;
    }

    // æ›´æ–°ç»Ÿè®¡æ•°å­—
    document.getElementById('total-posts').innerText = filteredCount + (isFilterOn ? " (ç­›é€‰å)" : "");
    document.getElementById('total-people').innerText = Object.keys(grouped).length;

    // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    renderPersons(grouped);
}

function parseCSVLine(line) {
    const result = [];
    let startValue = 0;
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        if (line[i] === '"') {
            inQuotes = !inQuotes;
        } else if (line[i] === ',' && !inQuotes) {
            let val = line.substring(startValue, i);
            if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1).replace(/""/g, '"');
            result.push(val);
            startValue = i + 1;
        }
    }
    let lastVal = line.substring(startValue);
    if (lastVal.startsWith('"') && lastVal.endsWith('"')) lastVal = lastVal.slice(1, -1).replace(/""/g, '"');
    result.push(lastVal);
    return result;
}

function parseCSV(text){
    const lines = text.trim().split('\n');
    return lines.slice(1).map(l => {
        const arr = parseCSVLine(l);
        
        if(arr.length < 5) return null;
        
        return {
            keyword: arr[0],
            title: arr[1] || 'æ— æ ‡é¢˜',
            url: arr[3],
            publish_time: arr[4],
            excerpt: arr.slice(5).join(',').substring(0, 100) + '...'
        };
    }).filter(item => item !== null && item.keyword);
}

function buildStats(data){
    const monthMap = {};
    const weekMap = {};
    const weekDays = [];

    const start = new Date(CURRENT_DATE);
    start.setDate(start.getDate() - 6);

    for(let i=0; i<7; i++){
        const d = new Date(start);
        d.setDate(d.getDate()+i);
        const k = d.toISOString().slice(0,10);
        weekDays.push(k);
        weekMap[k] = 0;
    }

    data.forEach(d => {
        if(!d.publish_time) return;
        
        const m = d.publish_time.slice(0,7);
        monthMap[m] = (monthMap[m]||0)+1;

        const day = d.publish_time.slice(0,10);
        if(weekMap[day] !== undefined){
            weekMap[day]++;
        }
    });

    return {
        monthly: {
            labels: Object.keys(monthMap).sort(),
            data: Object.keys(monthMap).sort().map(k => monthMap[k])
        },
        weekly: {
            labels: weekDays,
            data: weekDays.map(d => weekMap[d]),
            hasData: Object.values(weekMap).some(v => v > 0)
        }
    };
}

function drawLine(dom, labels, data, color='#0084ff'){
    if(!dom) return;
    const chart = echarts.init(dom);
    chart.setOption({
        tooltip: { trigger: 'axis' },
        grid: { top: 20, right: 10, bottom: 20, left: 30, containLabel: true },
        xAxis: { 
            type: 'category', 
            data: labels,
            axisLine: { lineStyle: { color: '#ddd' } },
            axisLabel: { color: '#999', fontSize: 11 }
        },
        yAxis: { 
            type: 'value', 
            minInterval: 1,
            splitLine: { lineStyle: { type: 'dashed', color: '#f0f0f0' } }
        },
        series: [{
            type: 'line',
            data: data,
            smooth: true,
            symbol: 'circle',
            symbolSize: 6,
            itemStyle: { color: color },
            areaStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: color.replace(')', ', 0.2)').replace('rgb', 'rgba') },
                    { offset: 1, color: 'rgba(255, 255, 255, 0)' }
                ])
            }
        }]
    });
    window.addEventListener('resize', () => chart.resize());
}

function drawWeekly(dom, stats){
    if(!stats.hasData){
        dom.innerHTML = '<div class="no-data-msg">è¿‘ä¸€å‘¨æ— æ›´æ–°</div>';
        return;
    }
    drawLine(dom, stats.labels.map(d => d.slice(5)), stats.data, '#0084ff');
}

function renderPersons(grouped){
    const area = document.getElementById('content-area');
    area.innerHTML = '';
    const isFilterOn = document.getElementById('negative-filter').checked;

    Object.keys(grouped).forEach((name, index) => {
        const personData = grouped[name];
        const stats = buildStats(personData);
        
        // æŒ‰æ—¶é—´å€’åº
        const sortedPosts = [...personData].sort((a, b) => {
            return new Date(b.publish_time) - new Date(a.publish_time);
        });
        
        const showPosts = sortedPosts.slice(0, 5); 

        let postsHtml = '<ul class="person-post-list">';
        showPosts.forEach(p => {
            let displayTitle = p.title;
            if (isFilterOn) {
                NEGATIVE_KEYWORDS.forEach(kw => {
                    displayTitle = displayTitle.replace(new RegExp(kw, 'g'), `<span style="color:#d32f2f;background:#ffebee;padding:0 2px;">${kw}</span>`);
                });
            }

            postsHtml += `
                <li>
                    <a href="${p.url}" target="_blank" title="${p.title}">
                        ${displayTitle}
                    </a>
                    <span class="post-date">${p.publish_time}</span>
                </li>
            `;
        });
        postsHtml += '</ul>';

        const card = document.createElement('div');
        card.className = 'person-card';
        const mChartId = `m-${index}`;
        const wChartId = `w-${index}`;

        card.innerHTML = `
            <div class="person-header">
                <div class="person-avatar">${name[0]}</div>
                <div class="person-info">
                    <h3>${name}</h3>
                    <span class="tag-badge">ç›¸å…³å†…å®¹: ${personData.length} ç¯‡</span>
                </div>
            </div>

            <div class="person-body">
                <div class="charts-wrapper small" style="grid-template-columns: 1fr;">
                    <div>
                        <h4 style="margin:0 0 5px 0; font-size:12px; color:#999;">æœˆåº¦å£°é‡</h4>
                        <div class="chart-container" id="${mChartId}" style="height:140px;"></div>
                    </div>
                    <div>
                        <h4 style="margin:10px 0 5px 0; font-size:12px; color:#999;">æœ¬å‘¨åŠ¨æ€</h4>
                        <div class="chart-container" id="${wChartId}" style="height:140px;"></div>
                    </div>
                </div>

                <div class="person-posts">
                    <h4>ğŸ“ ç²¾é€‰çŸ¥ä¹å›ç­”/æ–‡ç«  ${isFilterOn ? '(æœ€æ–°è´Ÿé¢)' : '(æœ€æ–°)'}</h4>
                    ${postsHtml}
                </div>
            </div>
        `;

        area.appendChild(card);
        
        setTimeout(() => {
            drawLine(document.getElementById(mChartId), stats.monthly.labels, stats.monthly.data, '#0084ff');
            drawWeekly(document.getElementById(wChartId), stats.weekly);
        }, 0);
    });
}

Promise.all([
    fetch('../data/zhihu_data.csv').then(r => { if(!r.ok) throw new Error(r.status); return r.text(); }),
    fetch('../data/zhihu_data_new.csv').then(r => { if(!r.ok) throw new Error(r.status); return r.text(); })
]).then(res => {
    document.getElementById('loading').style.display = 'none';

    // 1. åˆå¹¶åŸå§‹æ•°æ®
    const rawList = [...parseCSV(res[0]), ...parseCSV(res[1])];
    
    // 2. æ ¸å¿ƒä¿®æ”¹ï¼šå»é‡é€»è¾‘ (Keyword + URL)
    const uniqueMap = new Map();
    const all = [];

    rawList.forEach(item => {
        // ä½¿ç”¨ å…³é”®è¯ + URL ä½œä¸ºå”¯ä¸€æ ‡è¯†
        // è¿™æ ·å¯ä»¥å»é™¤åŒä¸€å…³é”®è¯ä¸‹çš„é‡å¤æ–‡ç« ï¼Œä½†ä¿ç•™åŒä¸€æ–‡ç« åœ¨ä¸åŒå…³é”®è¯ä¸‹çš„å¼•ç”¨
        const uniqueKey = `${item.keyword}_${item.url || item.title}`;
        
        if (!uniqueMap.has(uniqueKey)) {
            uniqueMap.set(uniqueKey, true);
            all.push(item);
        }
    });

    // 3. åç»­å¤„ç†ä½¿ç”¨å»é‡åçš„æ•°æ® 'all'
    GLOBAL_ALL_DATA = all;

    document.getElementById('total-posts').innerText = all.length;
    
    const globalStats = buildStats(all);
    drawLine(document.getElementById('global-month'), globalStats.monthly.labels, globalStats.monthly.data);
    drawWeekly(document.getElementById('global-week'), globalStats.weekly);

    const grouped = {};
    all.forEach(d => {
        grouped[d.keyword] = grouped[d.keyword] || [];
        grouped[d.keyword].push(d);
    });
    
    document.getElementById('total-people').innerText = Object.keys(grouped).length;
    renderPersons(grouped);

}).catch(err => {
    document.getElementById('loading').innerHTML = `
        <div style="text-align:center; color:#f00;">
            <p>æ•°æ®åŠ è½½å¤±è´¥</p>
            <small>${err.message}</small>
            <p>è¯·æ£€æŸ¥ ../data/ ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨ zhihu_data.csv å’Œ zhihu_data_new.csv</p>
        </div>
    `;
    console.error("Data Load Error:", err);
});

</script>

</body>
</html>