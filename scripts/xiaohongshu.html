<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å°çº¢ä¹¦æ•°æ®åˆ†æ - ç¤¾ä¼šé›·è¾¾</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="../CSS/xiaohongshu_data.css">
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var currentUrl = window.location.pathname;
    var menuLinks = document.querySelectorAll('.menu a');
    menuLinks.forEach(function(link) {
      if (link.getAttribute('href') && currentUrl.includes(link.getAttribute('href'))) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
  });
</script>

<header>
  <div class="container nav">
    <div class="brand">ç¤¾ä¼šé›·è¾¾ Â· Social Radar</div>
    <div class="menu">
      <a href="../index.html">é¦–é¡µ</a>
      <div class="dropdown">
        <a href="javascript:void(0)" class="dropbtn active">æ•°æ®åˆ†æ</a>
        <div class="dropdown-content">
          <a href="zhihu_data.html">çŸ¥ä¹</a>
          <a href="weibo_data.html">å¾®ä¿¡å…¬ä¼—å·</a>
          <a href="xiaohongshu_data.html" class="active">å°çº¢ä¹¦</a>
        </div>
      </div>
      <a href="analysis.html">CSVåˆ†æ</a>
      <a href="work.html">æˆ‘ä»¬çš„å·¥ä½œ</a>
    </div>
  </div>
</header>

<div class="container">
  
  <div class="card summary-card">
    <h2>æ•°æ®æ¦‚è§ˆ</h2>
    <div class="summary-stats">
        <div class="stat-item">
            <div class="stat-num" id="total-batches">0</div>
            <div class="stat-desc">ç›‘æ§è¯é¢˜</div>
        </div>
        <div class="stat-item">
            <div class="stat-num" id="total-notes">0</div>
            <div class="stat-desc">ç¬”è®°æ€»æ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-num" id="total-likes">0</div>
            <div class="stat-desc">æ€»è·èµæ•°</div>
        </div>
    </div>
  </div>

  <div class="card">
      <div class="card-header" style="border-bottom:none; padding-left:0;">
        <h2 style="margin:0; border-left:4px solid #ff2442; padding-left:10px;">å°çº¢ä¹¦ç»¼åˆçƒ­åº¦è¶‹åŠ¿ (æ‰€æœ‰è¯é¢˜æ€»å’Œ)</h2>
      </div>
      <div id="global-trend-chart" style="width: 100%; height: 350px;"></div>
  </div>

  <div class="card" style="margin: 20px 0; padding: 15px; display: flex; align-items: center; gap: 15px; background: #fff0f0; border: 1px solid #ffcccc;">
      <h3 style="margin: 0; font-size: 16px; color: #333;">ğŸ” æ•°æ®ç­›é€‰ï¼š</h3>
      <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
          <input type="checkbox" id="negative-filter" onchange="toggleFilter()">
          <span style="color: #d32f2f; font-weight: bold;">åªçœ‹â€œé¿é›·/åæ§½â€å†…å®¹</span>
      </label>
      <span style="color: #888; font-size: 12px;">(å…³é”®è¯ï¼šé¿é›·, è¸©å‘, å¤±æœ›, æ‹”è‰, å·®è¯„, åæ§½, æ— è¯­, åæ‚”...)</span>
  </div>

  <div id="content-area">
    <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
  </div>

</div>

<script>
const CURRENT_DATE = new Date(); 

// å®šä¹‰å°çº¢ä¹¦ç‰¹æœ‰çš„è´Ÿé¢å…³é”®è¯
const NEGATIVE_KEYWORDS = ["é¿é›·", "è¸©å‘", "å¤±æœ›", "å·®è¯„", "åæ§½", "é»‘æ¦œ", "åƒåœ¾", "æ— è¯­", "åˆ«å»", "åˆ«ä¹°", "åæ‚”", "ä¸Šå½“", "æ‹”è‰", "åŠé€€", "æ¶å¿ƒ", "ä¸è¡Œ", "çƒ‚", "æ™ºå•†ç¨"];

// å…¨å±€æ•°æ®
let GLOBAL_ALL_DATA = [];

/* ================= ç­›é€‰é€»è¾‘ ================= */
function toggleFilter() {
    const isFilterOn = document.getElementById('negative-filter').checked;
    const area = document.getElementById('content-area');
    
    // é‡æ–°åˆ†ç»„
    const grouped = {};
    let filteredCount = 0;

    GLOBAL_ALL_DATA.forEach(d => {
        // ç­›é€‰é€»è¾‘
        if (isFilterOn) {
            const textToCheck = d.title.toLowerCase();
            const hasNegativeWord = NEGATIVE_KEYWORDS.some(kw => textToCheck.includes(kw));
            if (!hasNegativeWord) return;
        }

        if (!grouped[d.batch_name]) grouped[d.batch_name] = [];
        grouped[d.batch_name].push(d);
        filteredCount++;
    });

    // å¦‚æœç­›é€‰åæ²¡æ•°æ®
    if (Object.keys(grouped).length === 0) {
        area.innerHTML = '<div style="text-align:center; padding:50px; color:#999;">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è´Ÿé¢å†…å®¹</div>';
        document.getElementById('total-notes').innerText = filteredCount + (isFilterOn ? " (ç­›é€‰å)" : "");
        return;
    }

    // æ›´æ–°ç»Ÿè®¡æ•°å­—
    document.getElementById('total-notes').innerText = filteredCount + (isFilterOn ? " (ç­›é€‰å)" : "");
    document.getElementById('total-batches').innerText = Object.keys(grouped).length;

    // é‡æ–°æ¸²æŸ“åˆ—è¡¨
    render(grouped);
}

function normalizeDate(dateStr) {
    if (!dateStr) return null;
    dateStr = dateStr.toString().trim();
    if (dateStr.match(/^\d{4}-\d{2}-\d{2}/)) return dateStr.substring(0, 10);
    const now = new Date(CURRENT_DATE);
    if (dateStr.includes('å°æ—¶') || dateStr.includes('åˆ†é’Ÿ') || dateStr.includes('åˆšåˆš')) return now.toISOString().slice(0, 10);
    if (dateStr.includes('æ˜¨å¤©')) { now.setDate(now.getDate() - 1); return now.toISOString().slice(0, 10); }
    if (dateStr.includes('å¤©å‰')) { const days = parseInt(dateStr)||0; now.setDate(now.getDate() - days); return now.toISOString().slice(0, 10); }
    if (dateStr.match(/^\d{2}-\d{2}$/)) return now.getFullYear() + '-' + dateStr;
    return null;
}

/* ================= CSV è§£æ ================= */
function parseCSVLine(line) {
    const result = [];
    let startValue = 0;
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        if (line[i] === '"') inQuotes = !inQuotes;
        else if (line[i] === ',' && !inQuotes) {
            let val = line.substring(startValue, i);
            if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1).replace(/""/g, '"');
            result.push(val);
            startValue = i + 1;
        }
    }
    let lastVal = line.substring(startValue);
    if (lastVal.startsWith('"') && lastVal.endsWith('"')) lastVal = lastVal.slice(1, -1).replace(/""/g, '"');
    result.push(lastVal);
    return result;
}

function parseCSV(text){
    const lines = text.trim().split('\n');
    return lines.slice(1).map(l => {
        const arr = parseCSVLine(l);
        if(arr.length < 5) return null;
        const rawDate = arr[3];
        const cleanDate = normalizeDate(rawDate);
        return {
            batch_name: arr[0] || 'æœªåˆ†ç±»',
            note_id: arr[1],
            title: arr[2] || 'æ— æ ‡é¢˜',
            publish_time: cleanDate,
            raw_time: rawDate,
            author_name: arr[4],
            like_count: parseInt(arr[6]) || 0,
            url: arr[11] || '#'
        };
    }).filter(d => d !== null && d.publish_time !== null);
}

/* ================= å…¨å±€è¶‹åŠ¿å›¾ ================= */
function renderGlobalTrendChart(allData) {
    const dom = document.getElementById('global-trend-chart');
    if(!dom) return;

    const dateMap = {};
    allData.forEach(d => {
        const date = d.publish_time;
        dateMap[date] = (dateMap[date] || 0) + 1;
    });

    const sortedDates = Object.keys(dateMap).sort();
    const counts = sortedDates.map(d => dateMap[d]);

    const chart = echarts.init(dom);
    chart.setOption({
        tooltip: { 
            trigger: 'axis',
            formatter: '{b} <br/> å…¨ç½‘æ€»æ–°å¢: {c} ç¯‡',
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            textStyle: { color: '#333' }
        },
        grid: { top: 30, left: 20, right: 30, bottom: 20, containLabel: true },
        xAxis: { 
            type: 'category', 
            data: sortedDates, 
            boundaryGap: false,
            axisLine: { lineStyle: { color: '#ccc' } }
        },
        yAxis: { 
            type: 'value', 
            minInterval: 1,
            splitLine: { lineStyle: { type: 'dashed', color: '#eee' } }
        },
        series: [{
            name: 'æ€»çƒ­åº¦',
            type: 'line',
            data: counts,
            smooth: true,
            symbol: 'circle',
            symbolSize: 8,
            itemStyle: { color: '#ff2442', borderColor: '#fff', borderWidth: 2 },
            lineStyle: { width: 3, shadowColor: 'rgba(255,36,66,0.3)', shadowBlur: 10 },
            areaStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: 'rgba(255, 36, 66, 0.3)' },
                    { offset: 1, color: 'rgba(255, 36, 66, 0.0)' }
                ])
            }
        }]
    });

    window.addEventListener('resize', () => chart.resize());
}

/* ================= å•ä¸ªè¯é¢˜è¶‹åŠ¿å›¾ ================= */
function buildTrendStats(data) {
    const dateMap = {};
    data.forEach(d => {
        dateMap[d.publish_time] = (dateMap[d.publish_time] || 0) + 1;
    });
    const sortedDates = Object.keys(dateMap).sort();
    return { dates: sortedDates, counts: sortedDates.map(d => dateMap[d]) };
}

function drawSmallChart(domId, stats, color) {
    const dom = document.getElementById(domId);
    if (!dom || stats.dates.length === 0) {
        if(dom) dom.innerHTML = '<div class="no-data">æš‚æ— æ•°æ®</div>';
        return;
    }
    const chart = echarts.init(dom);
    chart.setOption({
        tooltip: { trigger: 'axis' },
        grid: { top: 20, right: 10, bottom: 20, left: 30, containLabel: true },
        xAxis: { type: 'category', data: stats.dates, axisLine: { lineStyle: { color: '#eee' } } },
        yAxis: { type: 'value', minInterval: 1, splitLine: { lineStyle: { type: 'dashed', color: '#f5f5f5' } } },
        series: [{
            data: stats.counts, type: 'line', smooth: true, symbol: 'none',
            itemStyle: { color: color },
            areaStyle: {
                color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:color.replace(')',',0.2)').replace('rgb','rgba')},{offset:1,color:'rgba(255,255,255,0)'}])
            }
        }]
    });
    window.addEventListener('resize', () => chart.resize());
}

/* ================= é¡µé¢æ¸²æŸ“ä¸»é€»è¾‘ ================= */
function render(groupedData) {
    const container = document.getElementById('content-area');
    container.innerHTML = '';
    const isFilterOn = document.getElementById('negative-filter').checked;
    const batchNames = Object.keys(groupedData);

    batchNames.forEach((name, index) => {
        const items = groupedData[name];
        const totalLikes = items.reduce((sum, item) => sum + item.like_count, 0);
        const stats = buildTrendStats(items);
        
        // æŒ‰å‘å¸ƒæ—¶é—´å€’åºæ’åˆ— (æœ€æ–°çš„åœ¨æœ€å‰)
        const topPosts = [...items].sort((a, b) => {
            return new Date(b.publish_time) - new Date(a.publish_time);
        }).slice(0, 5); 

        let postsHtml = '<ul class="post-list">';
        topPosts.forEach(p => {
            // é«˜äº®å¤„ç†
            let displayTitle = p.title;
            if (isFilterOn) {
                NEGATIVE_KEYWORDS.forEach(kw => {
                    displayTitle = displayTitle.replace(new RegExp(kw, 'g'), `<span style="color:#d32f2f;background:#ffebee;padding:0 2px;">${kw}</span>`);
                });
            }

            postsHtml += `<li>
                <a href="${p.url}" target="_blank" title="${p.title}">${displayTitle}</a>
                <div class="post-meta"><span>â¤ï¸ ${p.like_count}</span><span class="date">${p.raw_time}</span></div>
            </li>`;
        });
        postsHtml += '</ul>';

        const chartId = `chart-${index}`;
        const card = document.createElement('div');
        card.className = 'topic-card';
        card.innerHTML = `
            <div class="card-header">
                <div class="topic-title"><span class="icon">#</span> ${name}</div>
                <div class="topic-stats">
                    <span class="badge">ç¬”è®°: ${items.length}</span>
                    <span class="badge red">è·èµ: ${totalLikes}</span>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-section">
                    <h4>è¯é¢˜çƒ­åº¦è¶‹åŠ¿ (ç¯‡/å¤©)</h4>
                    <div id="${chartId}" class="chart-box"></div>
                </div>
                <div class="list-section">
                    <h4>æœ€æ–°åŠ¨æ€ ${isFilterOn ? '(è´Ÿé¢)' : '(æŒ‰æ—¶é—´)'}</h4>
                    ${postsHtml}
                </div>
            </div>`;
        container.appendChild(card);
        setTimeout(() => drawSmallChart(chartId, stats, '#ff2442'), 0);
    });
}

/* ================= å…¥å£ ================= */
fetch('../data/xiaohongshu_data.csv')
    .then(r => r.text())
    .then(text => {
        const data = parseCSV(text);
        
        // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä¾›ç­›é€‰ä½¿ç”¨
        GLOBAL_ALL_DATA = data;
        
        document.getElementById('total-notes').innerText = data.length;
        document.getElementById('total-likes').innerText = data.reduce((s, d) => s + d.like_count, 0);

        renderGlobalTrendChart(data);

        // åˆå§‹åˆ†ç»„
        const grouped = {};
        data.forEach(d => {
            if (!grouped[d.batch_name]) grouped[d.batch_name] = [];
            grouped[d.batch_name].push(d);
        });
        
        document.getElementById('total-batches').innerText = Object.keys(grouped).length;
        render(grouped);
    })
    .catch(err => {
        console.error(err);
        document.getElementById('content-area').innerHTML = '<div style="text-align:center;padding:50px;color:red;">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„æˆ–è·¨åŸŸè®¾ç½®ã€‚</div>';
    });
</script>
</body>
</html>