<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>çŸ¥ä¹æ•°æ® - ç¤¾ä¼šé›·è¾¾</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* === å…¨å±€æ ·å¼ (ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œè¿™é‡Œé‡å¤äº†æ ·å¼ï¼Œå®é™…é¡¹ç›®ä¸­å»ºè®®å•ç‹¬å­˜ä¸º style.css) === */
:root{--bg:#f9fafb;--panel:#ffffff;--muted:#4b5563;--text:#111827;--accent:#0ea5e9;--border:#e5e7eb;--card:#ffffff;}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:15px/1.6 system-ui,sans-serif}
a{color:var(--accent);text-decoration:none}
.container{max-width:1080px;margin:0 auto;padding:24px}
header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);z-index:10}
.nav{display:flex;align-items:center;justify-content:space-between}
.brand{font-weight:800;letter-spacing:.3px}
.menu{display:flex;gap:14px}
.menu a{padding:10px 12px;border-radius:10px;color:var(--text)}
.menu a.active{background:var(--accent);color:#fff}
.menu a:hover:not(.active){background:rgba(0,0,0,.06)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.05)}
.muted{color:var(--muted)}
.pill{display:inline-block;padding:2px 8px;border-radius:6px;background:var(--bg);border:1px solid var(--border);margin-right:6px;font-size:12px;color:var(--accent)}
.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn.secondary{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
[data-theme="dark"]{--bg:#0b1220;--panel:#0e1627;--muted:#93a3b8;--text:#e6eef8;--accent:#38bdf8;--border:#1e293b;--card:#0b1530;}
[data-theme="dark"] header{background:rgba(11,18,32,.7)}
</style>
</head>
<body>

  <header>
    <div class="container nav">
      <div class="brand">ç¤¾ä¼šé›·è¾¾ Â· Social Radar</div>
      <nav class="menu">
        <a href="index.html">æ¦‚å¿µ</a>
        <a href="data.html" class="active">çŸ¥ä¹æ•°æ®</a>
        <a href="analysis.html">CSVåˆ†æ</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <div style="margin: 24px 0;">
      <h2>çŸ¥ä¹æŠ“å–ç»“æœ</h2>
      <p class="muted">å®æ—¶ç›‘æµ‹çš„ç¤¾ä¼šèˆ†è®ºå…³é”®è¯çƒ­åº¦ä¸åˆ†å¸ƒã€‚</p>
    </div>

    <div class="card" style="margin-bottom: 20px;">
      <div class="flex" style="justify-content: space-between; margin-bottom: 10px;">
         <h3 style="margin:0; font-size:16px;">ğŸ“Š å…³é”®è¯çƒ­åº¦åˆ†å¸ƒ</h3>
         <small class="muted">åŸºäº Top 15 æŠ“å–é¢‘æ¬¡ç»Ÿè®¡</small>
      </div>
      <div style="position: relative; height: 300px; width: 100%;">
        <canvas id="authorChart"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <div class="muted" id="resultsMeta">Loading...</div>
        <input
          id="kwFilter"
          placeholder="è¿‡æ»¤å…³é”®è¯ã€æ ‡é¢˜æˆ–ä½œè€…..."
          style="padding:8px 10px;border-radius:10px;border:1px solid var(--border);
                 background:var(--panel);color:var(--text);min-width:220px"
        />
      </div>
      <div id="resultsList" style="margin-top:12px">Loading...</div>
    </div>

    <p class="muted" style="margin-top:10px; font-size:13px;">
      æ•°æ®æ¥æºï¼šä»“åº“ data/zhihu_data.csv (æ¨¡æ‹Ÿæ¨¡å¼ä¸‹ä¸ºå†…ç½®æ•°æ®)
    </p>
  </main>

<script>
// === æ ¸å¿ƒé€»è¾‘ ===

let authorChartInstance = null;

// è§£æ CSV
function parseCSV(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  const headers = lines[0].split(',').map(h => h.trim());
  const result = [];
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    const currentLineValues = line.split(','); 
    const rowData = {};
    headers.forEach((header, index) => {
      let val = currentLineValues[index] || "";
      val = val.replace(/^"|"$/g, ''); 
      rowData[header] = val;
    });
    result.push(rowData);
  }
  return result;
}

function escapeHtml(s){
  return (s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

// æ›´æ–°å›¾è¡¨
function updateChart(rows) {
  const counts = {};
  rows.forEach(r => {
    const key = r.keyword ? r.keyword.trim() : "æœªåˆ†ç±»";
    counts[key] = (counts[key] || 0) + 1;
  });
  const sortedData = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 15);
  
  const style = getComputedStyle(document.documentElement);
  const ctx = document.getElementById('authorChart').getContext('2d');
  
  if (authorChartInstance) authorChartInstance.destroy();
  
  authorChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sortedData.map(i => i[0]),
      datasets: [{
        label: 'çƒ­åº¦',
        data: sortedData.map(i => i[1]),
        backgroundColor: style.getPropertyValue('--accent').trim(),
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: {display:false} },
      scales: {
        y: { beginAtZero: true, grid: { color: style.getPropertyValue('--border').trim() } },
        x: { grid: { display: false } }
      }
    }
  });
}

// æ¸²æŸ“åˆ—è¡¨
function renderRows(rows){
  const list = document.getElementById("resultsList");
  const kw = (document.getElementById("kwFilter").value || "").trim().toLowerCase();
  
  const filtered = kw ? rows.filter(r => 
    (r.title && r.title.toLowerCase().includes(kw)) ||
    (r.author && r.author.toLowerCase().includes(kw)) ||
    (r.keyword && r.keyword.toLowerCase().includes(kw))
  ) : rows;

  updateChart(filtered);

  if(filtered.length === 0){
    list.innerHTML = `<div class="muted" style="padding:12px 0">æ²¡æœ‰åŒ¹é…çš„æ•°æ®</div>`;
    return;
  }

  list.innerHTML = filtered.slice(0, 50).map(r => `
    <div style="padding:12px 0;border-bottom:1px solid var(--border)">
      <div style="font-weight:800;margin-bottom:6px">
        <a href="${r.url}" target="_blank">${escapeHtml(r.title)}</a>
      </div>
      <div class="muted" style="font-size:12px; display:flex; gap:8px; align-items:center;">
        <span class="pill">${escapeHtml(r.keyword)}</span>
        <span>${escapeHtml(r.author)}</span>
        <span>ğŸ‘ ${escapeHtml(r.upvotes)}</span>
        <span>ğŸ’¬ ${escapeHtml(r.comments)}</span>
      </div>
      <div style="margin-top:6px;line-height:1.6;font-size:14px;opacity:0.9">
        ${escapeHtml(r.excerpt ? r.excerpt.substring(0, 100) + '...' : '')}
      </div>
    </div>
  `).join("");
}

// åŠ è½½æ•°æ®
async function loadResults(){
  const metaEl = document.getElementById("resultsMeta");
  let rows = [];
  try {
      // å°è¯•åŠ è½½çœŸå®CSV
      const res = await fetch("./data/zhihu_data.csv?t=" + Date.now());
      if(!res.ok) throw new Error("CSV not found");
      const csvText = await res.text();
      rows = parseCSV(csvText);
      metaEl.textContent = `å…± ${rows.length} æ¡æ•°æ® (å®æ—¶)`;
  } catch(e) {
      // æ¨¡æ‹Ÿæ•°æ®å›é€€
      console.warn("ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:", e);
      metaEl.textContent = "æ¼”ç¤ºæ•°æ®æ¨¡å¼";
      rows = [
          {keyword: "è‡ªåŠ¨é©¾é©¶", title: "è‡ªåŠ¨é©¾é©¶çš„æœªæ¥åœ¨å“ªé‡Œï¼Ÿ", author: "Elon Musk", upvotes: "1200", comments: "300", excerpt: "ç¤ºä¾‹æ•°æ®...", url: "#"},
          {keyword: "AI", title: "æ·±åº¦å­¦ä¹ åœ¨ç¤¾ä¼šå­¦ä¸­çš„åº”ç”¨", author: "Yann LeCun", upvotes: "800", comments: "100", excerpt: "AI å‘å±•è¿…é€Ÿ...", url: "#"},
          {keyword: "ç¤¾ä¼šé›·è¾¾", title: "ç¤¾ä¼šé›·è¾¾åŸç†è§£æ", author: "Team", upvotes: "50", comments: "5", excerpt: "å¤šæ™®å‹’æ•ˆåº”...", url: "#"},
          {keyword: "LLM", title: "GPT-5 å‘å¸ƒé¢„æµ‹", author: "OpenAI", upvotes: "3000", comments: "1000", excerpt: "å³å°†åˆ°æ¥...", url: "#"}
      ];
  }
  
  renderRows(rows);
  document.getElementById("kwFilter").addEventListener("input", () => renderRows(rows));
}

// åˆå§‹åŒ–
loadResults();

// ä¸»é¢˜åˆ‡æ¢
(function(){
  const root = document.documentElement;
  const saved = localStorage.getItem('theme');
  if(saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) root.setAttribute('data-theme','dark');
  
  const btn = document.createElement('button');
  btn.className = 'btn secondary';
  btn.textContent = 'ğŸŒ“';
  btn.style.marginLeft = '8px';
  btn.onclick = () => {
    const isDark = root.getAttribute('data-theme') === 'dark';
    root.setAttribute('data-theme', isDark ? 'light' : 'dark');
    localStorage.setItem('theme', isDark ? 'light' : 'dark');
    loadResults(); // é‡æ–°æ¸²æŸ“å›¾è¡¨é¢œè‰²
  };
  document.querySelector('.menu').appendChild(btn);
})();
</script>
</body>
</html>
