<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>çŸ¥ä¹æ•°æ® - ç¤¾ä¼šé›·è¾¾</title>

<link rel="stylesheet" href="../CSS/data.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<header>
  <div class="container nav">
    <div class="brand">ç¤¾ä¼šé›·è¾¾ Â· Social Radar</div>
    <nav class="menu">
      <a href="../index.html">é¦–é¡µ</a>
      <a href="data.html" class="active">çŸ¥ä¹æ•°æ®</a>
      <a href="analysis.html">CSVåˆ†æ</a>
      <a href="work.html">æˆ‘ä»¬çš„å·¥ä½œ</a>
    </nav>
  </div>
</header>

<main class="container">

  <div style="margin:24px 0;">
    <h2>çŸ¥ä¹æŠ“å–ç»“æœ</h2>
    <p class="muted">å®æ—¶ç›‘æµ‹çš„ç¤¾ä¼šèˆ†è®ºå…³é”®è¯çƒ­åº¦ä¸åˆ†å¸ƒã€‚</p>
  </div>

  <div class="card" style="margin-bottom:20px;">
    <div class="flex" style="justify-content:space-between;margin-bottom:10px;">
      <h3 style="margin:0;font-size:16px;">ğŸ“Š å…³é”®è¯çƒ­åº¦åˆ†å¸ƒ</h3>
      <small class="muted">åŸºäº Top 15 æŠ“å–é¢‘æ¬¡ç»Ÿè®¡</small>
    </div>
    <div style="position:relative;height:300px;width:100%;">
      <canvas id="authorChart"></canvas>
    </div>
  </div>

  <div class="card">
    <div class="flex" style="justify-content:space-between;align-items:center">
      <div class="muted" id="resultsMeta">Loading...</div>
      <input
        id="kwFilter"
        placeholder="è¿‡æ»¤å…³é”®è¯ã€æ ‡é¢˜æˆ–ä½œè€…..."
        style="padding:8px 10px;border-radius:10px;border:1px solid var(--border);
               background:var(--panel);color:var(--text);min-width:220px"
      />
    </div>

    <div id="resultsList" style="margin-top:12px">Loading...</div>
  </div>

  <p class="muted" style="margin-top:10px;font-size:13px;">
    æ•°æ®æ¥æºï¼šä»“åº“ data/zhihu_data.csvï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ä¸‹ä¸ºå†…ç½®æ•°æ®ï¼‰
  </p>

</main>

<script>
// === æ ¸å¿ƒé€»è¾‘ ===

let authorChartInstance = null;

function parseCSV(text){
  const lines = text.trim().split('\n');
  if(lines.length < 2) return [];
  const headers = lines[0].split(',').map(h => h.trim());
  const result = [];

  for(let i = 1; i < lines.length; i++){
    const line = lines[i].trim();
    if(!line) continue;

    const values = line.split(',');
    const row = {};
    headers.forEach((h, idx) => {
      let v = values[idx] || "";
      v = v.replace(/^"|"$/g, '');
      row[h] = v;
    });
    result.push(row);
  }
  return result;
}

function escapeHtml(s){
  return (s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

// === å›¾è¡¨æ›´æ–° ===
function updateChart(rows){
  const counts = {};
  rows.forEach(r => {
    const k = r.keyword ? r.keyword.trim() : "æœªåˆ†ç±»";
    counts[k] = (counts[k] || 0) + 1;
  });

  const sorted = Object.entries(counts)
    .sort((a,b) => b[1] - a[1])
    .slice(0,15);

  const style = getComputedStyle(document.documentElement);
  const ctx = document.getElementById("authorChart").getContext("2d");

  if(authorChartInstance) authorChartInstance.destroy();

  authorChartInstance = new Chart(ctx,{
    type:"bar",
    data:{
      labels: sorted.map(i => i[0]),
      datasets:[{
        data: sorted.map(i => i[1]),
        backgroundColor: style.getPropertyValue("--accent").trim(),
        borderRadius: 4
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        y:{beginAtZero:true,grid:{color:style.getPropertyValue("--border").trim()}},
        x:{grid:{display:false}}
      }
    }
  });
}

// === åˆ—è¡¨æ¸²æŸ“ï¼ˆæ ‡é¢˜å†…åµŒé“¾æ¥ï¼Œç‚¹å‡»å³å¯è·³è½¬ï¼‰ ===
function renderRows(rows){
  const list = document.getElementById("resultsList");
  const kw = (document.getElementById("kwFilter").value || "").toLowerCase();

  const filtered = kw ? rows.filter(r =>
    (r.title && r.title.toLowerCase().includes(kw)) ||
    (r.author && r.author.toLowerCase().includes(kw)) ||
    (r.keyword && r.keyword.toLowerCase().includes(kw))
  ) : rows;

  updateChart(filtered);

  if(filtered.length === 0){
    list.innerHTML = `<div class="muted" style="padding:12px 0">æ²¡æœ‰åŒ¹é…çš„æ•°æ®</div>`;
    return;
  }

  list.innerHTML = filtered.slice(0,50).map(r => `
    <div style="padding:12px 0;border-bottom:1px solid var(--border)">
      <div style="font-weight:800;margin-bottom:6px">
        <a href="${r.url || '#'}" target="_blank" rel="noopener">
          ${escapeHtml(r.title || 'ï¼ˆæ— æ ‡é¢˜ï¼‰')}
        </a>
      </div>

      <div class="muted" style="font-size:12px;display:flex;gap:8px;align-items:center;">
        <span class="pill">${escapeHtml(r.keyword)}</span>
        <span>${escapeHtml(r.author)}</span>
        <span>ğŸ‘ ${escapeHtml(r.upvotes)}</span>
        <span>ğŸ’¬ ${escapeHtml(r.comments)}</span>
      </div>

      <div style="margin-top:6px;line-height:1.6;font-size:14px;opacity:.9">
        ${escapeHtml(r.excerpt ? r.excerpt.substring(0,100) + '...' : '')}
      </div>
    </div>
  `).join("");
}

// === æ•°æ®åŠ è½½ ===
async function loadResults(){
  const meta = document.getElementById("resultsMeta");
  let rows = [];

  try{
    const res = await fetch("../data/zhihu_data.csv?t=" + Date.now());
    if(!res.ok) throw new Error("csv not found");
    const csv = await res.text();
    rows = parseCSV(csv);
    meta.textContent = `å…± ${rows.length} æ¡æ•°æ®ï¼ˆå®æ—¶ï¼‰`;
  }catch(e){
    meta.textContent = "æ¼”ç¤ºæ•°æ®æ¨¡å¼";
    rows = [
      {keyword:"è‡ªåŠ¨é©¾é©¶",title:"è‡ªåŠ¨é©¾é©¶çš„æœªæ¥åœ¨å“ªé‡Œï¼Ÿ",author:"Elon Musk",upvotes:"1200",comments:"300",excerpt:"ç¤ºä¾‹æ•°æ®...",url:"https://www.zhihu.com"},
      {keyword:"AI",title:"æ·±åº¦å­¦ä¹ åœ¨ç¤¾ä¼šå­¦ä¸­çš„åº”ç”¨",author:"Yann LeCun",upvotes:"800",comments:"100",excerpt:"AI å‘å±•è¿…é€Ÿ...",url:"https://www.zhihu.com"},
      {keyword:"ç¤¾ä¼šé›·è¾¾",title:"ç¤¾ä¼šé›·è¾¾åŸç†è§£æ",author:"Team",upvotes:"50",comments:"5",excerpt:"å¤šæ™®å‹’æ•ˆåº”...",url:"https://www.zhihu.com"}
    ];
  }

  renderRows(rows);
  document.getElementById("kwFilter").addEventListener("input", () => renderRows(rows));
}

loadResults();

// === ä¸»é¢˜åˆ‡æ¢ ===
(function(){
  const root = document.documentElement;
  const saved = localStorage.getItem("theme");
  if(saved === "dark" || (!saved && window.matchMedia("(prefers-color-scheme: dark)").matches)){
    root.setAttribute("data-theme","dark");
  }

  const btn = document.createElement("button");
  btn.className = "btn secondary";
  btn.textContent = "ğŸŒ“";
  btn.style.marginLeft = "8px";

  btn.onclick = () => {
    const isDark = root.getAttribute("data-theme") === "dark";
    root.setAttribute("data-theme", isDark ? "light" : "dark");
    localStorage.setItem("theme", isDark ? "light" : "dark");
    loadResults();
  };

  document.querySelector(".menu").appendChild(btn);
})();
</script>

</body>
</html>
