<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>知乎数据 - 社会雷达</title>

<link rel="stylesheet" href="../CSS/data.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<header>
  <div class="container nav">
    <div class="brand">社会雷达 · Social Radar</div>
    <nav class="menu">
      <a href="../index.html">首页</a>
      <a href="data.html" class="active">知乎数据</a>
      <a href="analysis.html">CSV分析</a>
      <a href="work.html">我们的工作</a>
    </nav>
  </div>
</header>

<main class="container">

  <div style="margin:24px 0;">
    <h2>知乎数据分析</h2>
  </div>

  <div id="resultsList"></div>

</main>

<script>
/* ================= 工具函数 ================= */

function escapeHtml(s){
  return (s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

/* ================= CSV 解析 ================= */

function parseCSV(text){
  const lines = text.trim().split("\n");
  if(lines.length < 2) return [];
  const headers = lines[0].split(",").map(h => h.trim());
  const rows = [];

  for(let i=1;i<lines.length;i++){
    const line = lines[i].trim();
    if(!line) continue;
    const values = line.split(",");
    const row = {};
    headers.forEach((h,idx)=>{
      let v = values[idx] || "";
      v = v.replace(/^"|"$/g,"");
      row[h] = v;
    });
    rows.push(row);
  }
  return rows;
}

/* ================= 按标题去重（仅用于展示列表） ================= */

function dedupeByTitle(rows){
  const map = new Map();
  rows.forEach(r=>{
    if(!map.has(r.title)){
      map.set(r.title, r);
    }
  });
  return Array.from(map.values());
}

/* ================= 按 keyword（姓名）分组 ================= */

function groupByKeyword(rows){
  const groups = {};
  rows.forEach(r=>{
    const name = r.keyword || "未知姓名";
    if(!groups[name]) groups[name] = [];
    groups[name].push(r);
  });
  return groups;
}

/* ================= 构建时间序列（不去重） ================= */

function buildTimeSeries(rows){
  const counter = {};
  rows.forEach(r=>{
    if(!r.time) return;
    counter[r.time] = (counter[r.time] || 0) + 1;
  });

  const entries = Object.entries(counter)
    .sort((a,b)=>new Date(a[0]) - new Date(b[0]));

  return {
    labels: entries.map(e=>e[0]),
    data: entries.map(e=>e[1])
  };
}

/* ================= 主渲染 ================= */

function render(rows){
  const container = document.getElementById("resultsList");
  container.innerHTML = "";

  const groups = groupByKeyword(rows);

  Object.entries(groups).forEach(([name, allRows], idx)=>{
    const chartId = `chart-${idx}`;
    const series = buildTimeSeries(allRows);

    // ⚠️ 帖子列表只在这里去重
    const uniqueRows = dedupeByTitle(allRows);

    const info = allRows[0];

    const block = document.createElement("div");
    block.className = "person-card";
    block.innerHTML = `
      <div class="person-left">
        <div class="person-name">${escapeHtml(name)}</div>
        <div class="person-org">${escapeHtml(info.org || "")}</div>
        <img class="person-avatar"
             src="${info.avatar || "https://via.placeholder.com/200"}">
      </div>

      <div class="person-right">
        <canvas id="${chartId}" height="160"></canvas>

        <div class="post-list">
          ${uniqueRows.slice(0,5).map(r=>`
            <div class="post-item">
              <a href="${r.author || "#"}" target="_blank" rel="noopener">
                ${escapeHtml(r.title || "（无标题）")}
              </a>
            </div>
          `).join("")}
        </div>
      </div>
    `;

    container.appendChild(block);

    const ctx = document.getElementById(chartId).getContext("2d");
    new Chart(ctx,{
      type:"line",
      data:{
        labels: series.labels,
        datasets:[{
          data: series.data,
          borderColor: getComputedStyle(document.documentElement)
            .getPropertyValue("--accent").trim(),
          tension:0.3,
          fill:false
        }]
      },
      options:{
        responsive:true,
        plugins:{legend:{display:false}},
        scales:{y:{beginAtZero:true}}
      }
    });
  });
}

/* ================= 数据加载 ================= */

async function loadData(){
  let rows = [];
  try{
    const res = await fetch("../data/zhihu_data.csv?t=" + Date.now());
    if(!res.ok) throw new Error();
    rows = parseCSV(await res.text());
  }catch(e){
    rows = [
      {
        keyword:"Elon Musk",
        org:"Tesla",
        title:"自动驾驶的未来在哪里？",
        time:"2025-01-10",
        author:"https://www.zhihu.com/people/elon-musk"
      },
      {
        keyword:"Elon Musk",
        org:"Tesla",
        title:"自动驾驶的未来在哪里？",
        time:"2025-01-10",
        author:"https://www.zhihu.com/people/elon-musk"
      },
      {
        keyword:"Yann LeCun",
        org:"Meta AI",
        title:"深度学习的边界",
        time:"2025-01-12",
        author:"https://www.zhihu.com/people/yann-lecun"
      }
    ];
  }
  render(rows);
}

loadData();
</script>

</body>
</html>
