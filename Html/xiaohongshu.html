<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>小红书数据 - 社会雷达</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="../CSS/xiaohongshu_data.css">
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<script>
  // 保持原有的导航高亮逻辑
  document.addEventListener('DOMContentLoaded', function() {
    var currentUrl = window.location.pathname;
    var menuLinks = document.querySelectorAll('.menu a');
    
    menuLinks.forEach(function(link) {
      // 简单的包含判断，防止空链接报错
      if (link.getAttribute('href') && currentUrl.includes(link.getAttribute('href'))) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
  });
</script>

<body>

<header>
  <div class="container nav">
    <div class="brand">社会雷达 · Social Radar</div>
    <div class="menu">
      <a href="../index.html">首页</a>
      
      <div class="dropdown">
        <a href="javascript:void(0)" class="dropbtn active">数据分析</a>
        <div class="dropdown-content">
          <a href="zhihu_data.html">知乎</a>
          <a href="weibo_data.html">微信公众号</a>
          <a href="xiaohongshu_data.html" class="active">小红书</a>
        </div>
      </div>

      <a href="analysis.html">CSV分析</a>
      <a href="work.html">我们的工作</a>
    </div>
  </div>
</header>

<div class="container">

  <div class="card">
    <h2>全量小红书数据趋势</h2>
    
    <div class="summary-bar" style="display:flex; gap:20px; margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid #eee;">
        <div>笔记总数: <strong id="total-count" style="color:#ff2442">0</strong></div>
        <div>覆盖博主: <strong id="author-count" style="color:#ff2442">0</strong></div>
    </div>

    <div class="charts-wrapper">
      <div>
        <h3>总数据趋势（按月）</h3>
        <div id="global-month" class="chart-container"></div>
      </div>
      <div>
        <h3>最近一周趋势（按日）</h3>
        <div id="global-week" class="chart-container"></div>
      </div>
    </div>
  </div>

  <div id="content-area"></div>

</div>

<script>
// 设定基准时间，模拟当前系统时间
const CURRENT_DATE = new Date('2026-01-02');

/* ================= 工具：日期清洗 ================= */
// 将 "3小时前" 等相对时间转换为标准 YYYY-MM-DD
function normalizeDate(dateStr) {
    if (!dateStr) return null;
    dateStr = dateStr.trim();
    // 如果已经是标准格式
    if (dateStr.match(/^\d{4}-\d{2}-\d{2}/)) return dateStr.substring(0, 10);

    const now = new Date(CURRENT_DATE);
    if (dateStr.includes('小时') || dateStr.includes('分钟') || dateStr.includes('刚刚')) {
        return now.toISOString().slice(0, 10);
    }
    if (dateStr.includes('昨天')) {
        now.setDate(now.getDate() - 1);
        return now.toISOString().slice(0, 10);
    }
    if (dateStr.includes('天前')) {
        const days = parseInt(dateStr) || 0;
        now.setDate(now.getDate() - days);
        return now.toISOString().slice(0, 10);
    }
    return null; // 无法解析的日期
}

/* ================= CSV 解析 ================= */
// 相比 split(',')，这个函数能处理标题里自带逗号的情况
function parseCSVLine(line) {
    const result = [];
    let startValue = 0;
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        if (line[i] === '"') {
            inQuotes = !inQuotes;
        } else if (line[i] === ',' && !inQuotes) {
            let val = line.substring(startValue, i);
            if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1).replace(/""/g, '"');
            result.push(val);
            startValue = i + 1;
        }
    }
    let lastVal = line.substring(startValue);
    if (lastVal.startsWith('"') && lastVal.endsWith('"')) lastVal = lastVal.slice(1, -1).replace(/""/g, '"');
    result.push(lastVal);
    return result;
}

function parseCSV(text){
  const lines = text.trim().split('\n');
  // 跳过表头
  return lines.slice(1).map(l => {
    // 使用增强版解析
    const arr = parseCSVLine(l);
    
    // 防止空行报错
    if(arr.length < 5) return null;

    // 清洗日期
    const cleanDate = normalizeDate(arr[2]);
    
    // 映射字段：CSV结构为 [note_id, title, publish_time, author_name, author_id, like_count...]
    return {
      note_id: arr[0],
      title: arr[1] || '无标题',
      publish_time: cleanDate, // 用于绘图的标准日期
      display_time: arr[2],    // 用于展示的原始日期文本
      author_name: arr[3],     // 对应知乎的 keyword
      like_count: parseInt(arr[5]) || 0,
      url: arr[10]
    };
  }).filter(item => item !== null && item.publish_time !== null);
}

/* ================= 数据处理 ================= */
function buildStats(data){
  const monthMap = {};
  const weekMap = {};
  const weekDays = [];

  const start = new Date(CURRENT_DATE);
  start.setDate(start.getDate() - 6);

  // 初始化最近7天
  for(let i=0; i<7; i++){
    const d = new Date(start);
    d.setDate(d.getDate()+i);
    const k = d.toISOString().slice(0,10);
    weekDays.push(k);
    weekMap[k] = 0;
  }

  data.forEach(d => {
    // 按月统计 YYYY-MM
    const m = d.publish_time.slice(0,7);
    monthMap[m] = (monthMap[m]||0) + 1;

    // 按日统计
    if(weekMap[d.publish_time] !== undefined){
      weekMap[d.publish_time]++;
    }
  });

  return {
    monthly: {
      labels: Object.keys(monthMap).sort(),
      data: Object.keys(monthMap).sort().map(k => monthMap[k])
    },
    weekly: {
      labels: weekDays,
      data: weekDays.map(d => weekMap[d]),
      hasData: Object.values(weekMap).some(v => v > 0)
    }
  };
}

/* ================= 图表绘制 ================= */
// 增加 color 参数，区分不同平台的主题色（小红书用红色）
function drawLine(dom, labels, data, color='#ff2442'){
  if(!dom) return;
  const chart = echarts.init(dom);
  chart.setOption({
    tooltip: { trigger: 'axis' },
    grid: { top: 30, bottom: 20, left: 40, right: 20, containLabel: true },
    xAxis: { 
        type: 'category', 
        data: labels,
        axisLine: { lineStyle: { color: '#ddd' } },
        axisLabel: { color: '#666' }
    },
    yAxis: { type: 'value', minInterval: 1 },
    series: [{
      type: 'line',
      data: data,
      smooth: true,
      symbolSize: 6,
      itemStyle: { color: color },
      areaStyle: {
        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
          { offset: 0, color: color.replace('rgb','rgba').replace(')',',0.3)') }, // 简单处理透明度
          { offset: 1, color: 'rgba(255,255,255,0)' }
        ])
      }
    }]
  });
  
  // 窗口缩放自适应
  window.addEventListener('resize', () => chart.resize());
}

function drawWeekly(dom, stats, color='#ff2442'){
  if(!stats.hasData){
    dom.innerHTML = '<div class="no-data-msg" style="text-align:center; line-height:200px; color:#999;">暂无本周数据</div>';
    return;
  }
  drawLine(dom, stats.labels.map(d => d.slice(5)), stats.data, color);
}

/* ================= 渲染人物 ================= */
function renderPersons(grouped){
  const area = document.getElementById('content-area');
  area.innerHTML = '';

  Object.keys(grouped).forEach(name => {
    const personData = grouped[name];
    const stats = buildStats(personData);
    
    // 计算总点赞，增加数据丰富度
    const totalLikes = personData.reduce((sum, p) => sum + p.like_count, 0);

    // 取前 5 条
    const showPosts = personData.slice(0, 5);

    let postsHtml = '<ul class="person-post-list">';
    showPosts.forEach(p => {
      postsHtml += `
        <li>
          <div style="display:flex; justify-content:space-between;">
              <a href="${p.url}" target="_blank" title="${p.title}" style="max-width:70%; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
                ${p.title}
              </a>
              <span style="font-size:12px; color:#ff2442;">❤️ ${p.like_count}</span>
          </div>
          <span class="post-date" style="display:block; font-size:12px; color:#aaa;">${p.display_time}</span>
        </li>
      `;
    });
    postsHtml += '</ul>';

    const card = document.createElement('div');
    card.className = 'person-card';

    // 仿照原有结构，增加博主头像颜色区分
    card.innerHTML = `
      <div class="person-header" style="display:flex; align-items:center; margin-bottom:15px; border-bottom:1px solid #f0f0f0; padding-bottom:10px;">
          <div class="person-avatar" style="background:#ffebee; color:#ff2442;">${name[0]}</div>
          <div style="margin-left:15px;">
            <div class="person-name">${name}</div>
            <div style="font-size:12px; color:#888;">笔记数: ${personData.length} | 总点赞: ${totalLikes}</div>
          </div>
      </div>

      <div class="person-body" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
         <div class="charts-wrapper small" style="display:block;">
            <div style="height:200px; margin-bottom:10px;">
               <h4 style="margin:0 0 10px 0; font-size:14px; color:#666;">发布热度</h4>
               <div class="chart-container" id="m-${name}" style="height:160px;"></div>
            </div>
         </div>

         <div class="person-posts">
            <h4 style="margin:0 0 10px 0; font-size:14px; color:#666;">热门/最新笔记</h4>
            ${postsHtml}
         </div>
      </div>
    `;

    area.appendChild(card);

    // 绘图
    drawLine(
      document.getElementById(`m-${name}`),
      stats.monthly.labels,
      stats.monthly.data
    );
  });
}

/* ================= 主流程 ================= */
// 读取小红书数据
fetch('../data/xiaohongshu_data.csv')
  .then(r => r.text())
  .then(text => {
    const all = parseCSV(text);

    // 更新顶部数字
    document.getElementById('total-count').innerText = all.length;
    
    // 1. 全局图表
    const globalStats = buildStats(all);
    drawLine(
      document.getElementById('global-month'),
      globalStats.monthly.labels,
      globalStats.monthly.data
    );
    drawWeekly(
      document.getElementById('global-week'),
      globalStats.weekly
    );

    // 2. 按博主分组 (author_name 替代 keyword)
    const grouped = {};
    all.forEach(d => {
      // 过滤掉空的作者名
      const key = d.author_name || '未知用户';
      grouped[key] ??= [];
      grouped[key].push(d);
    });
    
    document.getElementById('author-count').innerText = Object.keys(grouped).length;

    // 3. 渲染
    renderPersons(grouped);
  })
  .catch(err => {
      console.error(err);
      document.getElementById('content-area').innerHTML = '<p style="color:red; text-align:center;">数据加载失败，请检查文件路径或服务器设置。</p>';
  });

</script>

</body>
</html>