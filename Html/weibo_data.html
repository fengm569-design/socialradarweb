<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>å¾®åšèˆ†æƒ…åˆ†æ - ç¤¾ä¼šé›·è¾¾</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="../CSS/data.css">
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<style>
    /* é’ˆå¯¹å¾®åšé¡µé¢çš„ç‰¹å®šè¦†ç›–æ ·å¼ */
    :root {
        --primary-color: #e6162d; /* å¾®åšçº¢ */
        --primary-light: #fff0f0;
    }
    /* è°ƒæ•´ä¸€ä¸‹åŠ è½½é®ç½©çš„é¢œè‰²ä»¥åŒ¹é…å¾®åšçº¢ */
    #loading { color: var(--primary-color); }
</style>
</head>
<body>

<div id="loading">æ­£åœ¨è·å–æ•°æ®...</div>

<header>
  <div class="container nav">
    <div class="brand">ç¤¾ä¼šé›·è¾¾ Â· Social Radar</div>
    <div class="menu">
      <a href="../index.html">é¦–é¡µ</a>
      <div class="dropdown">
        <a href="javascript:void(0)" class="dropbtn active">æ•°æ®åˆ†æ</a>
        <div class="dropdown-content">
          <a href="zhihu_data.html">çŸ¥ä¹</a>
          <a href="weibo_data.html" class="active">å¾®ä¿¡å…¬ä¼—å·</a>
          <a href="xiaohongshu.html">å°çº¢ä¹¦</a>
        </div>
      </div>
      <a href="analysis.html">CSVåˆ†æ</a>
      <a href="work.html">æˆ‘ä»¬çš„å·¥ä½œ</a>
    </div>
  </div>
</header>

<div class="container">

  <div class="card">
    <h2>å…¨é‡å¾®åšæ•°æ®æ¦‚è§ˆ</h2>
    
    <div class="summary-bar">
        <div class="stat-box">
            <span class="stat-num" id="total-posts">0</span>
            <span class="stat-label">ç›‘æ§å¾®åšæ€»é‡</span>
        </div>
        <div class="stat-box">
            <span class="stat-num" id="total-people">0</span>
            <span class="stat-label">è¦†ç›–è¯é¢˜/åšä¸»</span>
        </div>
    </div>

    <div class="charts-wrapper">
      <div>
        <h3>æ€»å£°é‡è¶‹åŠ¿ï¼ˆæŒ‰æœˆï¼‰</h3>
        <div id="global-month" class="chart-container"></div>
      </div>
      <div>
        <h3>æœ€è¿‘ä¸€å‘¨å£°é‡ï¼ˆæŒ‰æ—¥ï¼‰</h3>
        <div id="global-week" class="chart-container"></div>
      </div>
    </div>
  </div>

  <div id="content-area"></div>

</div>

<script>
// å¯¼èˆªæ é«˜äº®é€»è¾‘
document.addEventListener('DOMContentLoaded', function() {
    var currentUrl = window.location.pathname;
    var menuLinks = document.querySelectorAll('.menu a');
    menuLinks.forEach(function(link) {
        if (link.getAttribute('href') && currentUrl.includes(link.getAttribute('href'))) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });
});

const CURRENT_DATE = new Date('2026-01-02');

/* ================= å·¥å…·ï¼šå¢å¼ºå‹ CSV è§£æ ================= */
// å¤„ç†å¸¦å¼•å·å’Œé€—å·çš„ CSV è¡Œ
function parseCSVLine(line) {
    const result = [];
    let startValue = 0;
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        if (line[i] === '"') {
            inQuotes = !inQuotes;
        } else if (line[i] === ',' && !inQuotes) {
            let val = line.substring(startValue, i);
            if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1).replace(/""/g, '"');
            result.push(val);
            startValue = i + 1;
        }
    }
    let lastVal = line.substring(startValue);
    if (lastVal.startsWith('"') && lastVal.endsWith('"')) lastVal = lastVal.slice(1, -1).replace(/""/g, '"');
    result.push(lastVal);
    return result;
}

function parseCSV(text){
    const lines = text.trim().split('\n');
    return lines.slice(1).map(l => {
        const arr = parseCSVLine(l);
        if(arr.length < 5) return null; // ç¡®ä¿åˆ—æ•°è¶³å¤Ÿ
        
        // æ˜ å°„å¾®åš CSV å­—æ®µ
        // ç»“æ„: keyword, source, username, created_at, content_text, url, ...
        return {
            keyword: arr[0],
            username: arr[2],
            created_at: arr[3],
            content_text: arr[4],
            url: arr[5]
        };
    }).filter(item => item !== null && item.keyword);
}

/* ================= æ•°æ®ç»Ÿè®¡ ================= */
function buildStats(data){
    const monthMap = {};
    const weekMap = {};
    const weekDays = [];

    const start = new Date(CURRENT_DATE);
    start.setDate(start.getDate() - 6);

    for(let i=0; i<7; i++){
        const d = new Date(start);
        d.setDate(d.getDate()+i);
        const k = d.toISOString().slice(0,10);
        weekDays.push(k);
        weekMap[k] = 0;
    }

    data.forEach(d => {
        if(!d.created_at) return;
        
        // ç®€å•å¤„ç†æ—¥æœŸæ ¼å¼ï¼Œå‡è®¾æ˜¯ YYYY-MM-DD å¼€å¤´
        const m = d.created_at.slice(0,7);
        monthMap[m] = (monthMap[m]||0)+1;

        const day = d.created_at.slice(0,10);
        if(weekMap[day] !== undefined){
            weekMap[day]++;
        }
    });

    return {
        monthly: {
            labels: Object.keys(monthMap).sort(),
            data: Object.keys(monthMap).sort().map(k => monthMap[k])
        },
        weekly: {
            labels: weekDays,
            data: weekDays.map(d => weekMap[d]),
            hasData: Object.values(weekMap).some(v => v > 0)
        }
    };
}

/* ================= ç»˜å›¾å‡½æ•° ================= */
function drawLine(dom, labels, data, color='#e6162d'){
    if(!dom) return;
    const chart = echarts.init(dom);
    chart.setOption({
        tooltip: { trigger: 'axis' },
        grid: { top: 20, right: 10, bottom: 20, left: 30, containLabel: true },
        xAxis: { 
            type: 'category', 
            data: labels,
            axisLine: { lineStyle: { color: '#ddd' } },
            axisLabel: { color: '#999', fontSize: 11 }
        },
        yAxis: { 
            type: 'value', 
            minInterval: 1,
            splitLine: { lineStyle: { type: 'dashed', color: '#f0f0f0' } }
        },
        series: [{
            type: 'line',
            data: data,
            smooth: true,
            symbol: 'circle',
            symbolSize: 6,
            itemStyle: { color: color },
            areaStyle: {
                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: color.replace(')', ', 0.2)').replace('rgb', 'rgba') },
                    { offset: 1, color: 'rgba(255, 255, 255, 0)' }
                ])
            }
        }]
    });
    window.addEventListener('resize', () => chart.resize());
}

function drawWeekly(dom, stats){
    if(!stats.hasData){
        dom.innerHTML = '<div class="no-data-msg">è¿‘ä¸€å‘¨æ— æ›´æ–°</div>';
        return;
    }
    drawLine(dom, stats.labels.map(d => d.slice(5)), stats.data, '#e6162d');
}

/* ================= æ¸²æŸ“äººç‰©/è¯é¢˜å¡ç‰‡ ================= */
function renderPersons(grouped){
    const area = document.getElementById('content-area');
    area.innerHTML = '';

    Object.keys(grouped).forEach((keyword, index) => {
        const personData = grouped[keyword];
        const stats = buildStats(personData);
        const showPosts = personData.slice(0, 5); // å–å‰5æ¡

        let postsHtml = '<ul class="person-post-list">';
        showPosts.forEach(p => {
            // å¾®åšå†…å®¹é€šå¸¸è¾ƒé•¿ï¼Œåšä¸ªæˆªæ–­å¤„ç†
            const displayContent = p.content_text.length > 60 ? p.content_text.substring(0, 60) + '...' : p.content_text;
            
            postsHtml += `
                <li>
                    <a href="${p.url}" target="_blank" title="${p.content_text}">
                        ${displayContent}
                    </a>
                    <span class="post-date">${p.created_at}</span>
                </li>
            `;
        });
        postsHtml += '</ul>';

        const card = document.createElement('div');
        card.className = 'person-card';
        
        // åŠ¨æ€ID
        const mChartId = `m-${index}`;
        const wChartId = `w-${index}`;

        card.innerHTML = `
            <div class="person-header">
                <div class="person-avatar">${keyword[0]}</div>
                <div class="person-info">
                    <h3>${keyword}</h3>
                    <span class="tag-badge">å¾®åšæ•°: ${personData.length}</span>
                </div>
            </div>

            <div class="person-body">
                <div class="charts-wrapper small" style="grid-template-columns: 1fr;">
                    <div>
                        <h4 style="margin:0 0 5px 0; font-size:12px; color:#999;">æœˆåº¦å£°é‡</h4>
                        <div class="chart-container" id="${mChartId}" style="height:140px;"></div>
                    </div>
                    <div>
                        <h4 style="margin:10px 0 5px 0; font-size:12px; color:#999;">æœ¬å‘¨åŠ¨æ€</h4>
                        <div class="chart-container" id="${wChartId}" style="height:140px;"></div>
                    </div>
                </div>

                <div class="person-posts">
                    <h4>ğŸ“¢ ç²¾é€‰å¾®åšåŠ¨æ€</h4>
                    ${postsHtml}
                </div>
            </div>
        `;

        area.appendChild(card);

        // æ¸²æŸ“å°å›¾è¡¨
        setTimeout(() => {
            drawLine(document.getElementById(mChartId), stats.monthly.labels, stats.monthly.data, '#e6162d');
            drawWeekly(document.getElementById(wChartId), stats.weekly);
        }, 0);
    });
}

/* ================= ä¸»ç¨‹åºå…¥å£ ================= */
Promise.all([
    fetch('../data/weibo_data.csv').then(r => { if(!r.ok) throw new Error(r.status); return r.text(); }),
    fetch('../data/weibo_data_new.csv').then(r => { if(!r.ok) throw new Error(r.status); return r.text(); })
]).then(res => {
    document.getElementById('loading').style.display = 'none';

    // åˆå¹¶ä¸¤ä¸ªCSVçš„æ•°æ®
    const all = [...parseCSV(res[0]), ...parseCSV(res[1])];

    // 1. æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡
    document.getElementById('total-posts').innerText = all.length;
    
    // 2. å…¨å±€è¶‹åŠ¿å›¾
    const globalStats = buildStats(all);
    drawLine(document.getElementById('global-month'), globalStats.monthly.labels, globalStats.monthly.data, '#e6162d');
    drawWeekly(document.getElementById('global-week'), globalStats.weekly);

    // 3. åˆ†ç»„æ¸²æŸ“
    const grouped = {};
    all.forEach(d => {
        grouped[d.keyword] = grouped[d.keyword] || [];
        grouped[d.keyword].push(d);
    });
    document.getElementById('total-people').innerText = Object.keys(grouped).length;
    renderPersons(grouped);

}).catch(err => {
    document.getElementById('loading').innerHTML = `
        <div style="text-align:center; color:#f00;">
            <p>æ•°æ®åŠ è½½å¤±è´¥</p>
            <small>${err.message}</small>
            <p>è¯·æ£€æŸ¥ ../data/ ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨ weibo_data.csv å’Œ weibo_data_new.csv</p>
        </div>
    `;
    console.error("Data Load Error:", err);
});

</script>

</body>
</html>