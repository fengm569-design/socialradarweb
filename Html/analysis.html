<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CSV 智能分析 - 社会雷达</title>
<link rel="stylesheet" href="../CSS/work.css">
<link rel="stylesheet" href="../CSS/analysis.css">
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>

<body>

<header>
  <div class="container nav">
    <div class="brand">社会雷达 · Social Radar</div>
    <div class="menu">
      <a href="../index.html">首页</a>
      <div class="dropdown">
        <a href="javascript:void(0)" class="dropbtn">数据分析</a>
        <div class="dropdown-content">
          <a href="zhihu_data.html">知乎</a>
          <a href="weibo_data.html">微信公众号</a>
          <a href="xiaohongshu.html">小红书</a>
        </div>
      </div>
      <a href="analysis.html" class="active">CSV分析</a>
      <a href="work.html">我们的工作</a>
      
      <button id="theme-toggle" class="btn-icon" title="切换主题">
        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      </button>
    </div>
  </div>
</header>

<main class="container">
  <section class="page-header">
    <h1>CSV 数据智能分析</h1>
    <p class="subtitle">上传您的社交媒体数据，即刻生成基于社会多普勒框架的传播分析报告。</p>
  </section>

  <div class="upload-card" id="upload-card">
    <div class="drop-area" id="drop-area">
      <div class="icon-cloud">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </div>
      <h3>点击或拖拽 CSV 文件至此</h3>
      <p class="hint">支持格式：UTF-8 编码 CSV，需包含时间字段 (如 publish_time, created_at)</p>
      <input id="file-input" type="file" accept=".csv" style="display:none" />
      <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">选择文件</button>
    </div>
  </div>

  <div id="result-section" style="display:none;">
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="label">数据总量</div>
            <div class="value" id="res-total">0</div>
        </div>
        <div class="stat-card">
            <div class="label">时间跨度</div>
            <div class="value sub" id="res-range">-</div>
        </div>
        <div class="stat-card">
            <div class="label">峰值传播速度</div>
            <div class="value" id="res-peak">0</div>
        </div>
    </div>

    <div class="chart-card">
        <div class="chart-header">
            <h2>传播多普勒效应模拟</h2>
            <div class="chart-legend">
                <span class="dot primary"></span> 传播热度 (S)
                <span class="dot secondary" style="margin-left:15px"></span> 传播速度 (v)
            </div>
        </div>
        <div id="main-chart" style="width:100%; height:400px;"></div>
        <p class="chart-note">
            * <strong>传播热度</strong>：单位时间内的内容/互动数量。<br>
            * <strong>传播速度 (Velocity)</strong>：热度的一阶导数，模拟社会波的传播速率。正值代表话题加速扩散，负值代表衰减。
        </p>
    </div>

    <div style="text-align:center; margin-top:30px;">
        <button class="btn btn-secondary" onclick="resetPage()">重新上传</button>
        <button class="btn btn-primary" onclick="alert('报告已生成 PDF (演示)')">下载分析报告</button>
    </div>
  </div>

</main>

<script>
// ================= 核心逻辑 =================

const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('file-input');
const resultSection = document.getElementById('result-section');

// 1. 拖拽交互
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
});
function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
});
['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
});

dropArea.addEventListener('drop', handleDrop, false);
function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
}

fileInput.addEventListener('change', function() {
    handleFiles(this.files);
});

function handleFiles(files) {
    if(files.length > 0) {
        const file = files[0];
        if(file.type !== "text/csv" && !file.name.endsWith('.csv')) {
            alert("请上传 CSV 格式文件");
            return;
        }
        processFile(file);
    }
}

// 2. 文件处理与解析
function processFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        try {
            const data = parseCSV(text);
            if(data.length === 0) throw new Error("数据为空或格式无法识别");
            analyzeAndRender(data);
        } catch(err) {
            alert("解析失败: " + err.message);
        }
    };
    reader.readAsText(file);
}

// 通用 CSV 解析器 (同之前页面)
function parseCSV(text) {
    const lines = text.trim().split('\n');
    if(lines.length < 2) return [];
    
    // 自动识别时间列索引
    const headers = lines[0].toLowerCase().split(',');
    let timeIndex = -1;
    // 尝试匹配常见的时间字段名
    ['time', 'date', 'created_at', 'publish_time', 'timestamp'].forEach(key => {
        if(timeIndex === -1) timeIndex = headers.findIndex(h => h.includes(key));
    });
    
    if(timeIndex === -1) timeIndex = 2; // 默认尝试第3列作为时间

    return lines.slice(1).map(l => {
        // 简单处理引号内的逗号 (简化版)
        const arr = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); 
        const rawDate = arr[timeIndex] ? arr[timeIndex].replace(/"/g, '') : null;
        return {
            date: normalizeDate(rawDate)
        };
    }).filter(d => d.date !== null);
}

function normalizeDate(str) {
    if(!str) return null;
    str = str.trim();
    // 尝试解析 YYYY-MM-DD
    const match = str.match(/\d{4}-\d{2}-\d{2}/);
    if(match) return match[0];
    // 处理相对时间 (假设当天)
    if(str.includes('小时') || str.includes('分')) return new Date().toISOString().slice(0,10);
    return null; 
}

// 3. 数据分析与渲染
function analyzeAndRender(data) {
    // 按日期聚合
    const dateMap = {};
    data.forEach(d => {
        dateMap[d.date] = (dateMap[d.date] || 0) + 1;
    });

    const sortedDates = Object.keys(dateMap).sort();
    if(sortedDates.length === 0) {
        alert("未能在文件中找到有效的时间数据，请检查 CSV。");
        return;
    }

    const counts = sortedDates.map(d => dateMap[d]);

    // 计算“速度” (一阶导数模拟)
    const velocity = counts.map((val, i) => {
        if(i === 0) return 0;
        return val - counts[i-1];
    });

    // 更新界面
    document.getElementById('upload-card').style.display = 'none';
    resultSection.style.display = 'block';

    document.getElementById('res-total').innerText = data.length.toLocaleString();
    document.getElementById('res-range').innerText = `${sortedDates[0]} 至 ${sortedDates[sortedDates.length-1]}`;
    const maxV = Math.max(...velocity);
    document.getElementById('res-peak').innerText = "+" + maxV;

    // 绘制 ECharts
    const chart = echarts.init(document.getElementById('main-chart'));
    const option = {
        tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
        grid: { top: 40, right: 50, bottom: 40, left: 50 },
        legend: { show: false }, // 使用自定义图例
        xAxis: { type: 'category', data: sortedDates, boundaryGap: false },
        yAxis: [
            { type: 'value', name: '热度', position: 'left', splitLine: { show: false } },
            { type: 'value', name: '速度', position: 'right', splitLine: { lineStyle: { type: 'dashed' } } }
        ],
        series: [
            {
                name: '传播热度',
                type: 'line',
                smooth: true,
                data: counts,
                yAxisIndex: 0,
                itemStyle: { color: '#0084ff' },
                areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(0,132,255,0.2)'},{offset:1,color:'rgba(0,132,255,0)'}]) }
            },
            {
                name: '传播速度',
                type: 'line',
                smooth: true,
                data: velocity,
                yAxisIndex: 1,
                itemStyle: { color: '#ff8200' },
                lineStyle: { type: 'dashed', width: 2 }
            }
        ]
    };
    chart.setOption(option);
    window.addEventListener('resize', () => chart.resize());
}

function resetPage() {
    fileInput.value = '';
    document.getElementById('upload-card').style.display = 'block';
    resultSection.style.display = 'none';
}

// 主题切换逻辑
document.addEventListener('DOMContentLoaded', () => {
    const toggleBtn = document.getElementById('theme-toggle');
    const root = document.documentElement;
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        root.setAttribute('data-theme', 'dark');
    }
    toggleBtn.addEventListener('click', () => {
        const isDark = root.getAttribute('data-theme') === 'dark';
        const newTheme = isDark ? 'light' : 'dark';
        root.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    });
});
</script>

</body>
</html>