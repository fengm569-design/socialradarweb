<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>社会雷达 Social Radar</title>
  <meta name="description" content="一个用于展示与原型验证的社会雷达单页站点" />
  <style>
    :root{
      --bg:#0b1220;        /* 背景深色 */
      --panel:#0e1627;     /* 面板 */
      --muted:#93a3b8;     /* 次级文本 */
      --text:#e6eef8;      /* 主文本 */
      --accent:#7dd3fc;    /* 强调（蓝青） */
      --accent2:#a78bfa;   /* 次强调（紫） */
      --border:#1e293b;    /* 边框 */
      --card:#0b1530;      /* 卡片底 */
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    img{max-width:100%;display:block}
    .container{max-width:1080px;margin:0 auto;padding:24px}
    header{position:sticky;top:0;background:rgba(11,18,32,.7);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);z-index:10}
    .nav{display:flex;align-items:center;justify-content:space-between}
    .brand{font-weight:800;letter-spacing:.3px}
    .menu{display:flex;gap:14px}
    .menu a{padding:10px 12px;border-radius:10px}
    .menu a:hover{background:rgba(255,255,255,.06)}
    .hero{padding:68px 0 28px}
    .hero h1{font-size:40px;margin:8px 0}
    .hero p{color:var(--muted);max-width:760px}
    .btns{display:flex;gap:12px;margin-top:18px;flex-wrap:wrap}
    .btn{display:inline-block;padding:10px 14px;border-radius:12px;background:var(--accent);color:#06203a;font-weight:800}
    .btn.secondary{background:transparent;border:1px solid var(--border);color:var(--text)}
    section{padding:36px 0;border-top:1px solid var(--border)}
    h2{margin:0 0 14px;font-size:22px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-8{grid-column:span 8}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    .muted{color:var(--muted)}
    footer{padding:28px 0;color:var(--muted)}
    code,kbd{background:#0f223f;color:#cde7ff;padding:2px 6px;border-radius:8px}
    .badge{display:inline-block;border:1px solid var(--border);padding:4px 8px;border-radius:999px;color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#10223e;border:1px solid var(--border);margin-right:6px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .table{width:100%;border-collapse:collapse;font-size:14px}
    .table th,.table td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left}
    .kbd{border:1px solid var(--border);padding:2px 6px;border-radius:6px;background:#0d1b34}
    @media (max-width:900px){.col-6,.col-4,.col-8{grid-column:span 12}.hero{padding-top:48px}.hero h1{font-size:32px}}
    /* 简易图例 */
    .legend{display:flex;gap:10px;align-items:center}
    .legend span{display:inline-block;width:12px;height:12px;border-radius:3px;background:var(--accent)}
    .legend .s2{background:var(--accent2)}
    /* 上传区域 */
    .drop{border:1px dashed var(--border);border-radius:14px;padding:16px;background:#0d1b34}
  </style>
</head>
<body>
  <!-- 顶部导航 -->
  <header>
    <div class="container nav">
      <div class="brand">社会雷达 · Social Radar</div>
      <nav class="menu">
        <a href="#about">概念</a>
        <a href="#analyze">上传与分析</a>
        <a href="#dashboard">可视化</a>
        <a href="#docs">说明</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- 主页横幅 -->
    <section class="hero" id="home">
      <p class="muted">Social Sensing | Doppler-like Shift | Weighted Signals</p>
      <h1>社会雷达</h1>
      <p>
        本页提供一个可直接部署到 GitHub Pages 的<strong>原型站点</strong>
      </p>
      <div class="btns">
        <a class="btn" href="#analyze">立即试用</a>
        <a class="btn secondary" href="#docs">如何部署</a>
      </div>
    </section>

    <!-- 概念 -->
    <section id="about">
      <h2>概念简述</h2>
      <div class="grid">
        <div class="col-6 card">
          <p>
          </p>
          <p class="muted">下方仅为原型公式：</p>
          <p>
          </p>
          </div>
            </tbody>
          </table>
        </div>
      </div>
    </section>



    <!-- 上传与分析 -->
    <section id="analyze">
      <h2>上传与分析</h2>
      <div class="card">
        <div class="flex" style="justify-content:space-between">
          <div>
            <span class="badge">CSV 仅保留三列：date, star, like</span>
          </div>
          <div>
            <label>窗口 k：<input id="win" type="number" value="5" min="1" max="60" class="kbd" style="width:72px"></label>
            <label style="margin-left:10px">α：<input id="alpha" type="number" step="0.1" value="1.0" class="kbd" style="width:72px"></label>
          </div>
        </div>
        <div class="drop" id="drop">
          <input id="file" type="file" accept=".csv" />
          <p class="muted">或将 CSV 拖拽到此处</p>
        </div>
        <div class="legend" style="margin-top:12px">
          <span></span><small>MA<sub>k</sub>(star)</small>
          <span class="s2"></span><small>SR(t) 频移</small>
        </div>
        <canvas id="chart" width="1024" height="360" style="width:100%;margin-top:10px;border:1px solid var(--border);border-radius:12px;background:#0d1b34"></canvas>
        <div class="flex" style="margin-top:10px">
          <a id="download" class="btn secondary" href="#" download="social_radar_result.csv" style="padding:8px 12px">下载结果 CSV</a>
          <small class="muted" id="summary"></small>
        </div>
      </div>
    </section>

    <!-- 简易“仪表板”说明 -->
    <section id="dashboard">
      <h2>可视化解释</h2>
      <div class="grid">
        <div class="col-8 card">
          <p>
            图中蓝青色线为平滑后的 <code>MA_k(star)</code>，紫色线为加权“频移” <code>SR(t)</code>。当紫线显著上扬时，表示情绪评分的变化方向与强度在 <code>like</code> 权重的放大下更为明显；当紫线下探时，说明在关注度权重下，情绪变化偏负或转弱。
          </p>
          <p class="muted">注意：这是研究原型，可按你的论文设定替换指标定义与参数。</p>
        </div>
        <div class="col-4 card">
          <h3 style="margin:0 0 8px">可定制项</h3>
          <ul>
            <li>替换 <code>SR(t)</code> 公式（如使用一阶差分、对数差分、或<code>like</code>的幂次加权）</li>
            <li>引入更多通道（转发、评论极性）并做多通道融合</li>
            <li>更换平滑器（指数滑动平均、Hampel 滤波等）</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- 说明与部署 -->
    <section id="docs">
      <h2>部署与二次开发</h2>
      <div class="grid">
        <div class="col-6 card">
          <h3 style="margin:0 0 8px">GitHub Pages 部署</h3>
          <ol>
            <li>将本文件保存为 <code>index.html</code> 上传到 GitHub 仓库根目录</li>
            <li>仓库设置 → <strong>Pages</strong> → <em>Deploy from branch</em>，选择 <code>main</code> 分支与 <em>/root</em></li>
            <li>等待构建完成，访问提示的网址即可</li>
          </ol>
        </div>
        <div class="col-6 card">
          <h3 style="margin:0 0 8px">数据与伦理</h3>
          <ul>
            <li>仅在符合法律与平台协议前提下抓取或使用数据</li>
            <li>对个人隐私做匿名化与最小必要处理</li>
            <li>研究结论应报告不确定性与潜在偏差</li>
          </ul>
        </div>
      </div>
    </section>

    <footer>
      <div class="container">
        <small class="muted">© 2025 社会雷达 · 研究原型页面。前端纯静态、无数据外传，所有计算均在浏览器本地完成。</small>
      </div>
    </footer>
  </main>

  <script>
    // 简单 CSV 解析（逗号分隔，首行表头包含 date, star, like）
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const header = lines[0].split(',').map(s=>s.trim().toLowerCase());
      const idx = {
        date: header.indexOf('date'),
        star: header.indexOf('star'),
        like: header.indexOf('like')
      };
      if(idx.date<0||idx.star<0||idx.like<0){throw new Error('CSV 必须包含列：date, star, like');}
      const rows = [];
      for(let i=1;i<lines.length;i++){
        if(!lines[i].trim()) continue;
        const cols = lines[i].split(',');
        const d = new Date(cols[idx.date].trim());
        const star = parseFloat(cols[idx.star]);
        const like = parseFloat(cols[idx.like]);
        if(isFinite(d) && isFinite(star) && isFinite(like)){
          const key = d.toISOString().slice(0,10); // 聚合到日
          rows.push({date:key, star, like});
        }
      }
      // 按日聚合（均值）
      const byDay = {};
      for(const r of rows){
        if(!byDay[r.date]) byDay[r.date] = {date:r.date, n:0, star:0, like:0};
        byDay[r.date].n++; byDay[r.date].star += r.star; byDay[r.date].like += r.like;
      }
      const arr = Object.values(byDay).map(o=>({date:o.date, star:o.star/o.n, like:o.like/o.n}));
      arr.sort((a,b)=>a.date.localeCompare(b.date));
      return arr;
    }

    function movingAvg(series, k){
      const out = new Array(series.length).fill(null);
      for(let i=0;i<series.length;i++){
        const s = Math.max(0, i-k+1);
        const window = series.slice(s, i+1);
        const mean = window.reduce((acc,v)=>acc+v,0)/window.length;
        out[i] = mean;
      }
      return out;
    }

    function normalize(arr){
      const min = Math.min(...arr), max = Math.max(...arr);
      if(max-min===0) return arr.map(()=>0.0);
      return arr.map(v => (v-min)/(max-min));
    }

    function computeSR(data, k, alpha){
      const star = data.map(d=>d.star);
      const like = data.map(d=>d.like);
      const ma = movingAvg(star, k);
      const likeN = normalize(like);
      const sr = ma.map((v,i)=>{
        const prev = i>0? ma[i-1] : ma[i];
        const diff = v - prev; // 一阶差分
        return diff * (1 + alpha * likeN[i]);
      });
      return {ma, sr};
    }

    function drawChart(canvas, dates, ma, sr){
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      const W = canvas.width, H = canvas.height, P = 36; // padding
      // 轴
      ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(P, P); ctx.lineTo(P, H-P); ctx.lineTo(W-P, H-P); ctx.stroke();
      // 计算范围
      const allY = [...ma, ...sr].filter(v=>v!==null && isFinite(v));
      const yMin = Math.min(...allY), yMax = Math.max(...allY);
      const xStep = (W-2*P)/Math.max(1, dates.length-1);
      function yMap(v){
        if(yMax===yMin) return H/2;
        return H-P - (v - yMin) / (yMax - yMin) * (H-2*P);
      }
      // 网格
      ctx.strokeStyle = 'rgba(255,255,255,0.06)';
      for(let i=0;i<5;i++){
        const y = P + i*(H-2*P)/4; ctx.beginPath(); ctx.moveTo(P,y); ctx.lineTo(W-P,y); ctx.stroke();
      }
      // 画线函数
      function drawLine(arr, color){
        ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
        for(let i=0;i<arr.length;i++){
          const x = P + i*xStep; const y = yMap(arr[i]);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
      }
      // 绘制
      drawLine(ma, '#7dd3fc'); // 蓝青
      drawLine(sr, '#a78bfa'); // 紫
      // 简易刻度
      ctx.fillStyle = '#93a3b8'; ctx.font = '12px system-ui';
      const tickN = 6;
      for(let i=0;i<tickN;i++){
        const t = i/(tickN-1); const y = H-P - t*(H-2*P);
        const val = (yMin + t*(yMax-yMin)).toFixed(2);
        ctx.fillText(val, 6, y+4);
      }
      // X 轴日期（最多 8 个）
      const step = Math.ceil(dates.length/8);
      for(let i=0;i<dates.length;i+=step){
        const x = P + i*xStep; ctx.fillText(dates[i].slice(5), x-14, H-P+14);
      }
    }

    // 文件读取 + 事件绑定
    const fileInput = document.getElementById('file');
    const drop = document.getElementById('drop');
    const chart = document.getElementById('chart');
    const summary = document.getElementById('summary');
    const download = document.getElementById('download');

    function handleFile(f){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const k = Math.max(1, parseInt(document.getElementById('win').value||5,10));
          const alpha = parseFloat(document.getElementById('alpha').value||1.0);
          const data = parseCSV(reader.result);
          const {ma, sr} = computeSR(data, k, alpha);
          const dates = data.map(d=>d.date);
          drawChart(chart, dates, ma, sr);
          // 汇总
          const last = sr[sr.length-1];
          const meanSR = sr.reduce((a,b)=>a+b,0)/sr.length;
          summary.textContent = `共 ${dates.length} 天；k=${k}，α=${alpha}；最后一天 SR=${last.toFixed(4)}；均值 SR=${meanSR.toFixed(4)}`;
          // 导出 CSV
          const header = 'date,star_ma,SR\n';
          const lines = dates.map((d,i)=>`${d},${ma[i].toFixed(6)},${sr[i].toFixed(6)}`).join('\n');
          const blob = new Blob([header+lines], {type:'text/csv'});
          download.href = URL.createObjectURL(blob);
        }catch(err){
          alert('解析/计算失败：'+err.message);
        }
      };
      reader.readAsText(f);
    }

    fileInput.addEventListener('change', e=>{
      if(e.target.files && e.target.files[0]) handleFile(e.target.files[0]);
    });
    ;['dragenter','dragover'].forEach(evt=>drop.addEventListener(evt, e=>{e.preventDefault(); drop.style.background='#0c1d39';}));
    ;['dragleave','drop'].forEach(evt=>drop.addEventListener(evt, e=>{e.preventDefault(); drop.style.background='#0d1b34';}));
    drop.addEventListener('drop', e=>{
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if(f) handleFile(f);
    });
  </script>
</body>
</html>
