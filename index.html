<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç¤¾ä¼šé›·è¾¾ Social Radar</title>
<meta name="description" content="ç¤¾ä¼šé›·è¾¾åŸå‹ï¼šåŸºäºå¤šæ™®å‹’æ•ˆåº”çš„èˆ†è®ºæ„ŸçŸ¥ä¸å¯è§†åŒ–ã€‚" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body,{delimiters:[{left:'$$', right:'$$', display:true},{left:'$', right:'$', display:false}]});"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f9fafb; --panel:#ffffff; --muted:#4b5563; --text:#111827;
  --accent:#0ea5e9; --border:#e5e7eb; --card:#ffffff;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:15px/1.6 system-ui,-apple-system,sans-serif}
a{color:var(--accent);text-decoration:none}
.container{max-width:1080px;margin:0 auto;padding:24px}
header{position:sticky;top:0;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);z-index:10}
.nav{display:flex;align-items:center;justify-content:space-between}
.brand{font-weight:800}
.menu{display:flex;gap:14px}
.menu a{padding:10px 12px;border-radius:10px;color:var(--text)}
.menu a:hover{background:rgba(0,0,0,.05)}
.hero{padding:50px 0 30px}
.hero h1{font-size:36px;margin:10px 0}
.btn{padding:8px 14px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:14px}
.btn.secondary{background:transparent;border:1px solid var(--border);color:var(--text)}
section{padding:30px 0;border-top:1px solid var(--border)}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;box-shadow:0 1px 2px rgba(0,0,0,0.03)}
.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.muted{color:var(--muted)}
.pill{padding:2px 8px;border-radius:4px;background:var(--bg);border:1px solid var(--border);font-size:12px;color:var(--accent)}
input{padding:8px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text)}

/* æ·±è‰²æ¨¡å¼ */
[data-theme="dark"]{
  --bg:#0b1220; --panel:#0e1627; --muted:#94a3b8; --text:#f1f5f9;
  --accent:#38bdf8; --border:#1e293b; --card:#0f172a;
}
[data-theme="dark"] header{background:rgba(15,23,42,.8)}
</style>
</head>
<body>

<header>
  <div class="container nav">
    <div class="brand">Social Radar</div>
    <nav class="menu">
      <a href="#results">å­¦è€…åˆ†æ</a>
      <a href="#analyze">CSVå·¥å…·</a>
      <a href="#papers">è®ºæ–‡</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="hero">
    <h1>ç¤¾ä¼šé›·è¾¾ï¼šå­¦è€…å½±å“åŠ›æ„ŸçŸ¥</h1>
    <p class="muted">Social Sensing & Doppler Analysis Prototype</p>
  </section>

  <section id="results">
    <div class="flex" style="justify-content:space-between; margin-bottom:15px;">
      <h2>é¢†åŸŸå­¦è€… / æ´»è·ƒäººç‰©åˆ†æ</h2>
      <input id="kwFilter" placeholder="è¾“å…¥å…³é”®è¯ç­›é€‰ (å¦‚: è‡ªåŠ¨é©¾é©¶)..." style="width:240px">
    </div>

    <div class="card" style="margin-bottom: 20px;">
      <div style="position: relative; height: 300px; width: 100%;">
        <canvas id="authorChart"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="flex" style="justify-content:space-between; border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:10px;">
        <span class="muted" id="resultsMeta">Loading data...</span>
      </div>
      <div id="resultsList"></div>
    </div>
  </section>

  <section id="analyze">
    <h2>CSV é¢‘ç§»æ¨¡æ‹Ÿ</h2>
    <div class="card">
      <p class="muted">ä¸Šä¼ è‡ªå®šä¹‰æ•°æ®è¿›è¡Œå¤šæ™®å‹’è®¡ç®—</p>
      <input id="file" type="file" accept=".csv" style="margin-bottom:10px">
      <canvas id="chart" width="1024" height="200" style="width:100%; border-radius:8px; background:var(--bg)"></canvas>
    </div>
  </section>
</main>

<script>
// ================= å…¨å±€é…ç½® =================
let authorChartInstance = null;

// ================= æ•°æ®è·å– =================
async function fetchJson(url){
  const res = await fetch(url + "?t=" + Date.now());
  if(!res.ok) throw new Error("404");
  return await res.json();
}

function escapeHtml(s){ return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;"); }

// ================= å›¾è¡¨æ ¸å¿ƒé€»è¾‘ (å·²ä¿®æ”¹æ ‡ç­¾) =================
function updateChart(rows) {
  // 1. æ•°æ®èšåˆï¼šç»Ÿè®¡æ¯ä¸ªå­¦è€…çš„å‡ºç°æ¬¡æ•°
  const counts = {};
  rows.forEach(r => {
    // å‡è®¾ JSON ä¸­çš„ author å­—æ®µå°±æ˜¯å­¦è€…åå­—
    // å¦‚æœä½ çš„æ•°æ®ç»“æ„ä¸åŒï¼Œè¯·åœ¨è¿™é‡Œä¿®æ”¹ï¼Œä¾‹å¦‚: r.scholar_name
    const name = r.author ? r.author.trim() : "åŒ¿å";
    counts[name] = (counts[name] || 0) + 1;
  });

  // 2. æ’åºï¼šå– Top 12
  const sortedData = Object.entries(counts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 12);

  const labels = sortedData.map(d => d[0]); // è¿™é‡Œå°±æ˜¯ã€å­¦è€…åå­—ã€‘
  const values = sortedData.map(d => d[1]);

  // 3. æ ·å¼è¯»å–
  const style = getComputedStyle(document.documentElement);
  const color = style.getPropertyValue('--accent').trim();
  const txtColor = style.getPropertyValue('--muted').trim();

  // 4. æ¸²æŸ“å›¾è¡¨
  const ctx = document.getElementById('authorChart').getContext('2d');
  if (authorChartInstance) authorChartInstance.destroy();

  authorChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels, // Xè½´æ ‡ç­¾ï¼šè®¾ç½®ä¸ºå­¦è€…åå­—
      datasets: [{
        label: 'å­¦è€…äº§å‡º / æåŠæ•°', // ã€ä¿®æ”¹ç‚¹ã€‘æ•°æ®é›†æ ‡ç­¾
        data: values,
        backgroundColor: color,
        borderRadius: 4,
        barPercentage: 0.6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, labels: { color: txtColor } }, // æ˜¾ç¤ºå›¾ä¾‹
        tooltip: {
          callbacks: {
            // è‡ªå®šä¹‰æç¤ºæ¡†æ–‡å­—
            title: (items) => `å­¦è€…ï¼š${items[0].label}`,
            label: (item) => ` ç›¸å…³åŠ¨æ€ï¼š${item.raw} æ¡`
          }
        }
      },
      scales: {
        x: {
          ticks: { color: txtColor, autoSkip: false, maxRotation: 45, minRotation: 0 },
          grid: { display: false },
          title: { // ã€ä¿®æ”¹ç‚¹ã€‘Xè½´æ ‡é¢˜
            display: true,
            text: 'å­¦è€…å§“å',
            color: txtColor,
            font: { size: 13, weight: 'bold' }
          }
        },
        y: {
          ticks: { color: txtColor, stepSize: 1 },
          grid: { color: style.getPropertyValue('--border').trim() },
          title: { // ã€ä¿®æ”¹ç‚¹ã€‘Yè½´æ ‡é¢˜
            display: true,
            text: 'å‡ºç°é¢‘æ¬¡',
            color: txtColor
          }
        }
      }
    }
  });
}

// ================= åˆ—è¡¨æ¸²æŸ“ =================
function renderRows(rows){
  const list = document.getElementById("resultsList");
  const kw = document.getElementById("kwFilter").value.trim().toLowerCase();
  
  // ç­›é€‰é€»è¾‘
  const filtered = kw ? rows.filter(r => 
    (r.title+r.author+r.keyword).toLowerCase().includes(kw)
  ) : rows;

  // è”åŠ¨æ›´æ–°å›¾è¡¨
  updateChart(filtered);

  // æ¸²æŸ“åˆ—è¡¨
  list.innerHTML = filtered.slice(0, 30).map(r => `
    <div style="padding:10px 0; border-bottom:1px solid var(--border)">
      <div style="font-weight:700; margin-bottom:4px">
        <a href="${r.url}" target="_blank">${escapeHtml(r.title)}</a>
      </div>
      <div class="muted" style="font-size:12px">
        <span class="pill" style="margin-right:6px">ğŸ‘¤ ${escapeHtml(r.author)}</span>
        <span>Topic: ${escapeHtml(r.keyword)}</span>
        <span style="float:right">ğŸ‘ ${r.upvotes}</span>
      </div>
    </div>
  `).join("");
}

// ================= åˆå§‹åŒ– =================
async function init(){
  try {
    // æ¨¡æ‹Ÿæ•°æ® (å½“ fetch å¤±è´¥æ—¶ä½¿ç”¨)
    const mockData = [
      {title:"è‡ªåŠ¨é©¾é©¶æ„ŸçŸ¥ç»¼è¿°", author:"ç‹å­¦è€…", keyword:"CV", upvotes:200, url:"#"},
      {title:"å¤§æ¨¡å‹åœ¨ç¤¾ä¼šå­¦åº”ç”¨", author:"ææ•™æˆ", keyword:"LLM", upvotes:150, url:"#"},
      {title:"å¤šæ™®å‹’é›·è¾¾æŠ€æœ¯", author:"SocialRadar Team", keyword:"Hardware", upvotes:300, url:"#"},
      {title:"æ·±åº¦å¼ºåŒ–å­¦ä¹ ", author:"å¼ åšå£«", keyword:"RL", upvotes:80, url:"#"},
      {title:"Transformer å˜ä½“ç ”ç©¶", author:"ç‹å­¦è€…", keyword:"NLP", upvotes:120, url:"#"},
      {title:"æ™ºèƒ½äº¤é€šç³»ç»Ÿ", author:"èµµç ”ç©¶å‘˜", keyword:"ITS", upvotes:90, url:"#"},
      {title:"ç”Ÿæˆå¼ AI ä¼¦ç†", author:"ææ•™æˆ", keyword:"Ethics", upvotes:210, url:"#"}
    ];

    let rows = mockData;
    try {
      const meta = await fetchJson("./data/meta.json");
      document.getElementById("resultsMeta").textContent = `æ•°æ®æ›´æ–°äº: ${meta.updated_at}`;
      rows = await fetchJson("./data/zhihu_data.json");
    } catch(e) { console.log("ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®..."); }

    renderRows(rows);
    document.getElementById("kwFilter").addEventListener("input", ()=>renderRows(rows));
    
  } catch(e) { alert("åˆå§‹åŒ–é”™è¯¯"); }
}

// ä¸»é¢˜åˆ‡æ¢é€»è¾‘
(function(){
  const btn = document.createElement('button');
  btn.textContent = "ğŸŒ“";
  btn.className = "btn secondary";
  btn.style.marginLeft="10px";
  btn.onclick = () => {
    const root = document.documentElement;
    const isDark = root.getAttribute('data-theme') === 'dark';
    root.setAttribute('data-theme', isDark ? 'light' : 'dark');
    init(); // é‡æ–°æ¸²æŸ“å›¾è¡¨é¢œè‰²
  };
  document.querySelector('.menu').appendChild(btn);
})();

init();
</script>
</body>
</html>
